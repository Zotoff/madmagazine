"use strict";
jQuery(function () {

  /* Handle scroll */

  $(window).scroll(() => {
    // const scrollPosition = $(window).scrollTop();
    // // const articlePoster = $(`#articlePoster`);
    // const header = $(`#mainHeader`);
    // const windowWidth = $(window).width();
    // // if (articlePoster) {
    // //   if (windowWidth >= 768) {
    // //     if (scrollPosition > 350) {
    // //       articlePoster.addClass(`article__poster--smallHeight`);
    // //     } else {
    // //       articlePoster.removeClass(`article__poster--smallHeight`);
    // //     }
    // //   }
    // //   if (windowWidth < 768) {
    // //     if (scrollPosition > 350) {
    // //       articlePoster.addClass(`article__poster--smallHeight`);
    // //     } else {
    // //       articlePoster.removeClass(`article__poster--smallHeight`);
    // //     }
    // //   }
    // // }
    // if (header) {
    //   if (windowWidth >= 768) {
    //     if (scrollPosition > 150) {
    //       header.addClass(`header--smallHeight`);
    //     } else {
    //       header.removeClass(`header--smallHeight`);
    //     }
    //   }
    //   if (windowWidth < 768) {
    //     if (scrollPosition > 150) {
    //       header.addClass(`header--smallHeight`);
    //     } else {
    //       header.removeClass(`header--smallHeight`);
    //     }
    //   }
    // }
  });

  /* Header resize */
// var $head = $( '.header' );
// $( '.ha-waypoint' ).each( function(i) {
// 	var $el = $( this ),
// 		animClassDown = $el.data( 'animateDown' ),
// 		animClassUp = $el.data( 'animateUp' );

// 	$el.waypoint( function( direction ) {
// 		if( direction === 'down' && animClassDown ) {
//       $head.attr('class', 'header ha-header ' + animClassDown);
// 		}
// 		else if( direction === 'up' && animClassUp ){
//       $head.attr('class', 'header ha-header ' + animClassUp);
//       console.log(`up`);
// 		}
// 	}, { offset: '100%' } );
// } );

  /* Handle comments like buttons */

  const mobileNav = $(`#headerMobileNav`);
  const mobileMenu = $(`#headerMobileMenu`);
  const mobileClose = $(`#headerMobileClose`);
  const mobileSubscribe = $(`#headerMobileSubscribe`);
  const footerSubscribeForm = $(`#footerSubscribe`);
  const headerSubscribeButton = $(`#headerSubscribeButton`);
  const postCommentsLink = $(`#postCommentsLink`);
  const postCommentsBlock = $(`#postComments`);

  const checkCommentLike = (item) => {
    const commentLikeButton = item.find(`.comments__like__btn--like`);
    const commentDisLikeButton = item.find(`.comments__like__btn--dislike`);
    const commentCount = item.find(`.comments__views`);
    let commentCountValue = +commentCount.attr(`data-count`);


    commentLikeButton.on(`click`, (evt) => {
      evt.preventDefault();
      commentDisLikeButton.removeClass(`comments__like__btn--active`);
      commentLikeButton.addClass(`comments__like__btn--active`);
      commentCountValue += 1;
      commentCount.text(`+${commentCountValue}`);
      commentCount.attr(`data-count`, commentCountValue);

      let commentId = item.attr(`data-commentid`);
      let commentURL = item.attr(`data-commentURL`);

      $.ajax({
        method: `GET`,
        url: commentURL,
        data: {
          commentId,
          commentCount: commentCountValue
        },
        success(response) {
          console.log(response);
        },
        error(response) {
          console.log(response);
        }
      });
    });
    commentDisLikeButton.on(`click`, (evt) => {
      evt.preventDefault();
      commentDisLikeButton.addClass(`comments__like__btn--active`);
      commentLikeButton.removeClass(`comments__like__btn--active`);
      commentCountValue -= 1;
      commentCount.text(`+${commentCountValue}`);
      commentCount.attr(`data-count`, commentCountValue);

      let commentId = item.attr(`data-commentid`);
      let commentURL = item.attr(`data-commentURL`);

      $.ajax({
        method: `GET`,
        url: commentURL,
        data: {
          commentId,
          commentCount: commentCountValue
        },
        success(response) {
          console.log(response);
        },
        error(response) {
          console.log(response);
        }
      });
    });
  };

  const commentBlocks = $(`.comments__block:not(.comments__block__form)`);
  commentBlocks.each(function () {
    const commentItems = $(this).find(`.comments__item`);
    commentItems.each(function () {
      checkCommentLike($(this));
      $(this).attr(`data-commentid`, `comment-${generateRandomId(8)}`);
      $(this).attr(`data-commenturl`, `./ajax/response.json`);
    });
  });

  mobileNav.on(`click`, (evt) => {
    evt.preventDefault();
    mobileMenu.addClass(`show`);
  });
  mobileClose.on(`click`, (evt) => {
    evt.preventDefault();
    mobileMenu.removeClass(`show`);
  });
  headerSubscribeButton.on(`click`, (evt) => {
    evt.preventDefault();
    footerSubscribeForm[0].scrollIntoView({block: `start`, behavior: `smooth`});
  });

  if (mobileSubscribe) {
    mobileSubscribe.on(`click`, (evt) => {
      evt.preventDefault();
      footerSubscribeForm[0].scrollIntoView({block: `start`, behavior: `smooth`});
      mobileMenu.removeClass(`show`);
    });
  }

  postCommentsLink.on(`click`, (evt) => {
    evt.preventDefault();
    // postCommentsBlock[0].scrollIntoView({block: `start`, behavior: `smooth`});
    $('html,body').animate({scrollTop: $(`.comments__filter`).offset().top - $('#mainHeader').outerHeight()}, 500);
  });

  const scrollToSection = (dataLink) => {
    const sectionsWithData = $(`section.short-section`);
    sectionsWithData.each(function () {
      const sectionWithData = $(this);
      if (dataLink === sectionWithData.attr(`data-id`)) {
        // sectionWithData[0].scrollIntoView({block: `start`, behavior: `smooth`});
        $('html,body').animate({scrollTop: $(this).offset().top - $('#mainHeader').outerHeight()}, 500);
      }
    });
  };

  const categoryNavList = $(`#categoryNavList li a`);
  categoryNavList.each(function (item) {
    const navLink = $(this);
    navLink.on(`click`, (evt) => {
      evt.preventDefault();
      const navLinkDataLink = $(this).attr(`data-link`);
      scrollToSection(navLinkDataLink);
    });
  });

  const commentsForm = $(`#commentsForm`);

  if (commentsForm) {
    if (commentsForm[0]) {
      commentsForm[0].reset();
    }

    commentsForm.validate({
      rules: {
        comment: {
          required: true,
          minlength: 2
        }
      },
      messages: {
        comment: {
          required: `Заполните поле!`,
          minlength: `Допустимо минимум два символа при вводе имени`
        }
      },
      submitHandler(form) {
        let comment = $(`textarea`).val();
        $.ajax({
            type: "GET",
            url: "./ajax/response.json",
            data: {name: `Author`, message: comment}
          }).done(function( msg ) {
            console.log(msg);
            form.reset();
            let commentMessage = $(`#commentMessage`);
            commentMessage.text(`Ваш комментарий успешно отправлен`);
            commentMessage.attr(`data-success`, true);
          }).fail(function() {
            let commentMessage = $(`#commentMessage`);
            commentMessage.text(`При отправке вашего запроса возникла ошибка`)
            console.log(`Something wrong`);
            commentMessage.attr(`data-success`, false);
          })
      }
    });
  }


});

/* Initiate sliders */
const articleCarousel = document.querySelector(`#articleCarousel`);
if (articleCarousel) {
  const slider = tns({
    container: `#articleCarousel`,
    slideBy: `page`,
    items: 1,
    controlsContainer: `#articleSliderControls`,
    navContainer: `#articleSliderNav`,
    loop: false,
  });
}

const desktopPromoSlider = document.querySelector(`#desktopPromoSlider`);
if (desktopPromoSlider) {
  const desktopPromoSlider = tns({
    container: `#desktopPromoSlider`,
    slideBy: `page`,
    items: 1,
    controls: false,
    nav: false,
  });
}

const mobilePromoSlider = document.querySelector(`#mobilePromoSlider`);
if (mobilePromoSlider) {
  const mobilePromoSlider = tns({
    container: `#mobilePromoSlider`,
    slideBy: `page`,
    items: 1,
    controls: false,
    nav: false,
  });
}

const mainPromoSlider = document.querySelector(`#mainPromoCarousel`);
if (mainPromoSlider) {
  const mainPromoSlider = tns({
    container: `#mainPromoCarousel`,
    slideBy: `page`,
    items: 1,
    controls: false,
    nav: false,
  });
}

/* Generate random ID */

const generateRandomId = (length) => {
  const letters = `0123456789ABCDEFGHIJKLMNOPQRSTUVWXTZabcdefghiklmnopqrstuvwxyz`.split(``);

  if (!length) {
    length = Math.floor(Math.random() * letters.length);
  }

  let str = ``;

  for (let i = 0; i < length; i++) {
    str += letters[Math.floor(Math.random() * letters.length)];
  }
  return str;
};

/* Post bookmark click */

const article = document.querySelector(`.article`);
const postBookmark = document.querySelector(`.post-bookmark`);
const postBookmarkMob = document.querySelector(`.post-bookmark--mob`);

if (article) {
  article.setAttribute(`data-id`, generateRandomId(8));
}

function setCookie(name, value, options = {}) {

  options = {
    path: '/',
    ...options
  };

  if (options.expires instanceof Date) {
    options.expires = options.expires.toUTCString();
  }

  let updatedCookie = encodeURIComponent(name) + "=" + encodeURIComponent(value);

  for (let optionKey in options) {
    updatedCookie += "; " + optionKey;
    let optionValue = options[optionKey];
    if (optionValue !== true) {
      updatedCookie += "=" + optionValue;
    }
  }

  document.cookie = updatedCookie;
}

function getCookie(name) {
  var matches = document.cookie.match(new RegExp(
    "(?:^|; )" + name.replace(/([\.$?*|{}\(\)\[\]\\\/\+^])/g, '\\$1') + "=([^;]*)"
  ));
  return matches ? decodeURIComponent(matches[1]) : '[]';
}

function deleteCookie(name) {
  setCookie(name, "", {
    'max-age': -1
  })
}

/* Working with cookies on bookmarks */

if (postBookmark) {
  postBookmark.addEventListener(`click`, (evt)=>{
    evt.preventDefault();

    let articleId = article.getAttribute(`data-id`);

    let state = 0;

    postBookmark.classList.toggle('post-bookmark--active');
    postBookmark.toggleAttribute(`enabled`);

    if (postBookmark.classList.contains('post-bookmark--active')) {
      state = 1;
    }
    let articlesList = JSON.parse(getCookie('articlesList')) || [];

    if (state && articlesList.indexOf(articleId) == -1) {
      articlesList.push(articleId);
    } else if (!state && articlesList.indexOf(articleId) != -1) {
      articlesList = articlesList.filter(item => item != articleId);
    }
    setCookie('articlesList', JSON.stringify(articlesList), {'max-age': 3600, expires: `Tue, 19 Jan 2038 03:14:07 GMT`});
  });
}

if (postBookmarkMob) {
  postBookmarkMob.addEventListener(`click`, (evt)=>{
    evt.preventDefault();

    let articleId = article.getAttribute(`data-id`);
    let articleCookieName = `data-id`;
    let postBookmarkIcon = postBookmarkMob.querySelector(`img`);

    if (postBookmarkIcon.getAttribute(`src`) === `img/icons/icon-bookmark.svg`) {
      postBookmarkIcon.setAttribute(`src`, `img/icons/icon-bookmark-fill.svg`);
    } else {
      postBookmarkIcon.setAttribute(`src`, `img/icons/icon-bookmark.svg`);
    }

    let cookieDate = new Date();
    cookieDate.setTime(cookieDate.getTime() + (1440 * 60 * 1000));
    let date = cookieDate.toUTCString();

    document.cookie = encodeURIComponent(articleCookieName) + `=` + encodeURIComponent(articleId) + `expires=` + date;
  });
}


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiIiwic291cmNlcyI6WyJtYWluLmpzIl0sInNvdXJjZXNDb250ZW50IjpbIlwidXNlIHN0cmljdFwiO1xualF1ZXJ5KGZ1bmN0aW9uICgpIHtcblxuICAvKiBIYW5kbGUgc2Nyb2xsICovXG5cbiAgJCh3aW5kb3cpLnNjcm9sbCgoKSA9PiB7XG4gICAgLy8gY29uc3Qgc2Nyb2xsUG9zaXRpb24gPSAkKHdpbmRvdykuc2Nyb2xsVG9wKCk7XG4gICAgLy8gLy8gY29uc3QgYXJ0aWNsZVBvc3RlciA9ICQoYCNhcnRpY2xlUG9zdGVyYCk7XG4gICAgLy8gY29uc3QgaGVhZGVyID0gJChgI21haW5IZWFkZXJgKTtcbiAgICAvLyBjb25zdCB3aW5kb3dXaWR0aCA9ICQod2luZG93KS53aWR0aCgpO1xuICAgIC8vIC8vIGlmIChhcnRpY2xlUG9zdGVyKSB7XG4gICAgLy8gLy8gICBpZiAod2luZG93V2lkdGggPj0gNzY4KSB7XG4gICAgLy8gLy8gICAgIGlmIChzY3JvbGxQb3NpdGlvbiA+IDM1MCkge1xuICAgIC8vIC8vICAgICAgIGFydGljbGVQb3N0ZXIuYWRkQ2xhc3MoYGFydGljbGVfX3Bvc3Rlci0tc21hbGxIZWlnaHRgKTtcbiAgICAvLyAvLyAgICAgfSBlbHNlIHtcbiAgICAvLyAvLyAgICAgICBhcnRpY2xlUG9zdGVyLnJlbW92ZUNsYXNzKGBhcnRpY2xlX19wb3N0ZXItLXNtYWxsSGVpZ2h0YCk7XG4gICAgLy8gLy8gICAgIH1cbiAgICAvLyAvLyAgIH1cbiAgICAvLyAvLyAgIGlmICh3aW5kb3dXaWR0aCA8IDc2OCkge1xuICAgIC8vIC8vICAgICBpZiAoc2Nyb2xsUG9zaXRpb24gPiAzNTApIHtcbiAgICAvLyAvLyAgICAgICBhcnRpY2xlUG9zdGVyLmFkZENsYXNzKGBhcnRpY2xlX19wb3N0ZXItLXNtYWxsSGVpZ2h0YCk7XG4gICAgLy8gLy8gICAgIH0gZWxzZSB7XG4gICAgLy8gLy8gICAgICAgYXJ0aWNsZVBvc3Rlci5yZW1vdmVDbGFzcyhgYXJ0aWNsZV9fcG9zdGVyLS1zbWFsbEhlaWdodGApO1xuICAgIC8vIC8vICAgICB9XG4gICAgLy8gLy8gICB9XG4gICAgLy8gLy8gfVxuICAgIC8vIGlmIChoZWFkZXIpIHtcbiAgICAvLyAgIGlmICh3aW5kb3dXaWR0aCA+PSA3NjgpIHtcbiAgICAvLyAgICAgaWYgKHNjcm9sbFBvc2l0aW9uID4gMTUwKSB7XG4gICAgLy8gICAgICAgaGVhZGVyLmFkZENsYXNzKGBoZWFkZXItLXNtYWxsSGVpZ2h0YCk7XG4gICAgLy8gICAgIH0gZWxzZSB7XG4gICAgLy8gICAgICAgaGVhZGVyLnJlbW92ZUNsYXNzKGBoZWFkZXItLXNtYWxsSGVpZ2h0YCk7XG4gICAgLy8gICAgIH1cbiAgICAvLyAgIH1cbiAgICAvLyAgIGlmICh3aW5kb3dXaWR0aCA8IDc2OCkge1xuICAgIC8vICAgICBpZiAoc2Nyb2xsUG9zaXRpb24gPiAxNTApIHtcbiAgICAvLyAgICAgICBoZWFkZXIuYWRkQ2xhc3MoYGhlYWRlci0tc21hbGxIZWlnaHRgKTtcbiAgICAvLyAgICAgfSBlbHNlIHtcbiAgICAvLyAgICAgICBoZWFkZXIucmVtb3ZlQ2xhc3MoYGhlYWRlci0tc21hbGxIZWlnaHRgKTtcbiAgICAvLyAgICAgfVxuICAgIC8vICAgfVxuICAgIC8vIH1cbiAgfSk7XG5cbiAgLyogSGVhZGVyIHJlc2l6ZSAqL1xuLy8gdmFyICRoZWFkID0gJCggJy5oZWFkZXInICk7XG4vLyAkKCAnLmhhLXdheXBvaW50JyApLmVhY2goIGZ1bmN0aW9uKGkpIHtcbi8vIFx0dmFyICRlbCA9ICQoIHRoaXMgKSxcbi8vIFx0XHRhbmltQ2xhc3NEb3duID0gJGVsLmRhdGEoICdhbmltYXRlRG93bicgKSxcbi8vIFx0XHRhbmltQ2xhc3NVcCA9ICRlbC5kYXRhKCAnYW5pbWF0ZVVwJyApO1xuXG4vLyBcdCRlbC53YXlwb2ludCggZnVuY3Rpb24oIGRpcmVjdGlvbiApIHtcbi8vIFx0XHRpZiggZGlyZWN0aW9uID09PSAnZG93bicgJiYgYW5pbUNsYXNzRG93biApIHtcbi8vICAgICAgICRoZWFkLmF0dHIoJ2NsYXNzJywgJ2hlYWRlciBoYS1oZWFkZXIgJyArIGFuaW1DbGFzc0Rvd24pO1xuLy8gXHRcdH1cbi8vIFx0XHRlbHNlIGlmKCBkaXJlY3Rpb24gPT09ICd1cCcgJiYgYW5pbUNsYXNzVXAgKXtcbi8vICAgICAgICRoZWFkLmF0dHIoJ2NsYXNzJywgJ2hlYWRlciBoYS1oZWFkZXIgJyArIGFuaW1DbGFzc1VwKTtcbi8vICAgICAgIGNvbnNvbGUubG9nKGB1cGApO1xuLy8gXHRcdH1cbi8vIFx0fSwgeyBvZmZzZXQ6ICcxMDAlJyB9ICk7XG4vLyB9ICk7XG5cbiAgLyogSGFuZGxlIGNvbW1lbnRzIGxpa2UgYnV0dG9ucyAqL1xuXG4gIGNvbnN0IG1vYmlsZU5hdiA9ICQoYCNoZWFkZXJNb2JpbGVOYXZgKTtcbiAgY29uc3QgbW9iaWxlTWVudSA9ICQoYCNoZWFkZXJNb2JpbGVNZW51YCk7XG4gIGNvbnN0IG1vYmlsZUNsb3NlID0gJChgI2hlYWRlck1vYmlsZUNsb3NlYCk7XG4gIGNvbnN0IG1vYmlsZVN1YnNjcmliZSA9ICQoYCNoZWFkZXJNb2JpbGVTdWJzY3JpYmVgKTtcbiAgY29uc3QgZm9vdGVyU3Vic2NyaWJlRm9ybSA9ICQoYCNmb290ZXJTdWJzY3JpYmVgKTtcbiAgY29uc3QgaGVhZGVyU3Vic2NyaWJlQnV0dG9uID0gJChgI2hlYWRlclN1YnNjcmliZUJ1dHRvbmApO1xuICBjb25zdCBwb3N0Q29tbWVudHNMaW5rID0gJChgI3Bvc3RDb21tZW50c0xpbmtgKTtcbiAgY29uc3QgcG9zdENvbW1lbnRzQmxvY2sgPSAkKGAjcG9zdENvbW1lbnRzYCk7XG5cbiAgY29uc3QgY2hlY2tDb21tZW50TGlrZSA9IChpdGVtKSA9PiB7XG4gICAgY29uc3QgY29tbWVudExpa2VCdXR0b24gPSBpdGVtLmZpbmQoYC5jb21tZW50c19fbGlrZV9fYnRuLS1saWtlYCk7XG4gICAgY29uc3QgY29tbWVudERpc0xpa2VCdXR0b24gPSBpdGVtLmZpbmQoYC5jb21tZW50c19fbGlrZV9fYnRuLS1kaXNsaWtlYCk7XG4gICAgY29uc3QgY29tbWVudENvdW50ID0gaXRlbS5maW5kKGAuY29tbWVudHNfX3ZpZXdzYCk7XG4gICAgbGV0IGNvbW1lbnRDb3VudFZhbHVlID0gK2NvbW1lbnRDb3VudC5hdHRyKGBkYXRhLWNvdW50YCk7XG5cblxuICAgIGNvbW1lbnRMaWtlQnV0dG9uLm9uKGBjbGlja2AsIChldnQpID0+IHtcbiAgICAgIGV2dC5wcmV2ZW50RGVmYXVsdCgpO1xuICAgICAgY29tbWVudERpc0xpa2VCdXR0b24ucmVtb3ZlQ2xhc3MoYGNvbW1lbnRzX19saWtlX19idG4tLWFjdGl2ZWApO1xuICAgICAgY29tbWVudExpa2VCdXR0b24uYWRkQ2xhc3MoYGNvbW1lbnRzX19saWtlX19idG4tLWFjdGl2ZWApO1xuICAgICAgY29tbWVudENvdW50VmFsdWUgKz0gMTtcbiAgICAgIGNvbW1lbnRDb3VudC50ZXh0KGArJHtjb21tZW50Q291bnRWYWx1ZX1gKTtcbiAgICAgIGNvbW1lbnRDb3VudC5hdHRyKGBkYXRhLWNvdW50YCwgY29tbWVudENvdW50VmFsdWUpO1xuXG4gICAgICBsZXQgY29tbWVudElkID0gaXRlbS5hdHRyKGBkYXRhLWNvbW1lbnRpZGApO1xuICAgICAgbGV0IGNvbW1lbnRVUkwgPSBpdGVtLmF0dHIoYGRhdGEtY29tbWVudFVSTGApO1xuXG4gICAgICAkLmFqYXgoe1xuICAgICAgICBtZXRob2Q6IGBHRVRgLFxuICAgICAgICB1cmw6IGNvbW1lbnRVUkwsXG4gICAgICAgIGRhdGE6IHtcbiAgICAgICAgICBjb21tZW50SWQsXG4gICAgICAgICAgY29tbWVudENvdW50OiBjb21tZW50Q291bnRWYWx1ZVxuICAgICAgICB9LFxuICAgICAgICBzdWNjZXNzKHJlc3BvbnNlKSB7XG4gICAgICAgICAgY29uc29sZS5sb2cocmVzcG9uc2UpO1xuICAgICAgICB9LFxuICAgICAgICBlcnJvcihyZXNwb25zZSkge1xuICAgICAgICAgIGNvbnNvbGUubG9nKHJlc3BvbnNlKTtcbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgfSk7XG4gICAgY29tbWVudERpc0xpa2VCdXR0b24ub24oYGNsaWNrYCwgKGV2dCkgPT4ge1xuICAgICAgZXZ0LnByZXZlbnREZWZhdWx0KCk7XG4gICAgICBjb21tZW50RGlzTGlrZUJ1dHRvbi5hZGRDbGFzcyhgY29tbWVudHNfX2xpa2VfX2J0bi0tYWN0aXZlYCk7XG4gICAgICBjb21tZW50TGlrZUJ1dHRvbi5yZW1vdmVDbGFzcyhgY29tbWVudHNfX2xpa2VfX2J0bi0tYWN0aXZlYCk7XG4gICAgICBjb21tZW50Q291bnRWYWx1ZSAtPSAxO1xuICAgICAgY29tbWVudENvdW50LnRleHQoYCske2NvbW1lbnRDb3VudFZhbHVlfWApO1xuICAgICAgY29tbWVudENvdW50LmF0dHIoYGRhdGEtY291bnRgLCBjb21tZW50Q291bnRWYWx1ZSk7XG5cbiAgICAgIGxldCBjb21tZW50SWQgPSBpdGVtLmF0dHIoYGRhdGEtY29tbWVudGlkYCk7XG4gICAgICBsZXQgY29tbWVudFVSTCA9IGl0ZW0uYXR0cihgZGF0YS1jb21tZW50VVJMYCk7XG5cbiAgICAgICQuYWpheCh7XG4gICAgICAgIG1ldGhvZDogYEdFVGAsXG4gICAgICAgIHVybDogY29tbWVudFVSTCxcbiAgICAgICAgZGF0YToge1xuICAgICAgICAgIGNvbW1lbnRJZCxcbiAgICAgICAgICBjb21tZW50Q291bnQ6IGNvbW1lbnRDb3VudFZhbHVlXG4gICAgICAgIH0sXG4gICAgICAgIHN1Y2Nlc3MocmVzcG9uc2UpIHtcbiAgICAgICAgICBjb25zb2xlLmxvZyhyZXNwb25zZSk7XG4gICAgICAgIH0sXG4gICAgICAgIGVycm9yKHJlc3BvbnNlKSB7XG4gICAgICAgICAgY29uc29sZS5sb2cocmVzcG9uc2UpO1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgICB9KTtcbiAgfTtcblxuICBjb25zdCBjb21tZW50QmxvY2tzID0gJChgLmNvbW1lbnRzX19ibG9jazpub3QoLmNvbW1lbnRzX19ibG9ja19fZm9ybSlgKTtcbiAgY29tbWVudEJsb2Nrcy5lYWNoKGZ1bmN0aW9uICgpIHtcbiAgICBjb25zdCBjb21tZW50SXRlbXMgPSAkKHRoaXMpLmZpbmQoYC5jb21tZW50c19faXRlbWApO1xuICAgIGNvbW1lbnRJdGVtcy5lYWNoKGZ1bmN0aW9uICgpIHtcbiAgICAgIGNoZWNrQ29tbWVudExpa2UoJCh0aGlzKSk7XG4gICAgICAkKHRoaXMpLmF0dHIoYGRhdGEtY29tbWVudGlkYCwgYGNvbW1lbnQtJHtnZW5lcmF0ZVJhbmRvbUlkKDgpfWApO1xuICAgICAgJCh0aGlzKS5hdHRyKGBkYXRhLWNvbW1lbnR1cmxgLCBgLi9hamF4L3Jlc3BvbnNlLmpzb25gKTtcbiAgICB9KTtcbiAgfSk7XG5cbiAgbW9iaWxlTmF2Lm9uKGBjbGlja2AsIChldnQpID0+IHtcbiAgICBldnQucHJldmVudERlZmF1bHQoKTtcbiAgICBtb2JpbGVNZW51LmFkZENsYXNzKGBzaG93YCk7XG4gIH0pO1xuICBtb2JpbGVDbG9zZS5vbihgY2xpY2tgLCAoZXZ0KSA9PiB7XG4gICAgZXZ0LnByZXZlbnREZWZhdWx0KCk7XG4gICAgbW9iaWxlTWVudS5yZW1vdmVDbGFzcyhgc2hvd2ApO1xuICB9KTtcbiAgaGVhZGVyU3Vic2NyaWJlQnV0dG9uLm9uKGBjbGlja2AsIChldnQpID0+IHtcbiAgICBldnQucHJldmVudERlZmF1bHQoKTtcbiAgICBmb290ZXJTdWJzY3JpYmVGb3JtWzBdLnNjcm9sbEludG9WaWV3KHtibG9jazogYHN0YXJ0YCwgYmVoYXZpb3I6IGBzbW9vdGhgfSk7XG4gIH0pO1xuXG4gIGlmIChtb2JpbGVTdWJzY3JpYmUpIHtcbiAgICBtb2JpbGVTdWJzY3JpYmUub24oYGNsaWNrYCwgKGV2dCkgPT4ge1xuICAgICAgZXZ0LnByZXZlbnREZWZhdWx0KCk7XG4gICAgICBmb290ZXJTdWJzY3JpYmVGb3JtWzBdLnNjcm9sbEludG9WaWV3KHtibG9jazogYHN0YXJ0YCwgYmVoYXZpb3I6IGBzbW9vdGhgfSk7XG4gICAgICBtb2JpbGVNZW51LnJlbW92ZUNsYXNzKGBzaG93YCk7XG4gICAgfSk7XG4gIH1cblxuICBwb3N0Q29tbWVudHNMaW5rLm9uKGBjbGlja2AsIChldnQpID0+IHtcbiAgICBldnQucHJldmVudERlZmF1bHQoKTtcbiAgICAvLyBwb3N0Q29tbWVudHNCbG9ja1swXS5zY3JvbGxJbnRvVmlldyh7YmxvY2s6IGBzdGFydGAsIGJlaGF2aW9yOiBgc21vb3RoYH0pO1xuICAgICQoJ2h0bWwsYm9keScpLmFuaW1hdGUoe3Njcm9sbFRvcDogJChgLmNvbW1lbnRzX19maWx0ZXJgKS5vZmZzZXQoKS50b3AgLSAkKCcjbWFpbkhlYWRlcicpLm91dGVySGVpZ2h0KCl9LCA1MDApO1xuICB9KTtcblxuICBjb25zdCBzY3JvbGxUb1NlY3Rpb24gPSAoZGF0YUxpbmspID0+IHtcbiAgICBjb25zdCBzZWN0aW9uc1dpdGhEYXRhID0gJChgc2VjdGlvbi5zaG9ydC1zZWN0aW9uYCk7XG4gICAgc2VjdGlvbnNXaXRoRGF0YS5lYWNoKGZ1bmN0aW9uICgpIHtcbiAgICAgIGNvbnN0IHNlY3Rpb25XaXRoRGF0YSA9ICQodGhpcyk7XG4gICAgICBpZiAoZGF0YUxpbmsgPT09IHNlY3Rpb25XaXRoRGF0YS5hdHRyKGBkYXRhLWlkYCkpIHtcbiAgICAgICAgLy8gc2VjdGlvbldpdGhEYXRhWzBdLnNjcm9sbEludG9WaWV3KHtibG9jazogYHN0YXJ0YCwgYmVoYXZpb3I6IGBzbW9vdGhgfSk7XG4gICAgICAgICQoJ2h0bWwsYm9keScpLmFuaW1hdGUoe3Njcm9sbFRvcDogJCh0aGlzKS5vZmZzZXQoKS50b3AgLSAkKCcjbWFpbkhlYWRlcicpLm91dGVySGVpZ2h0KCl9LCA1MDApO1xuICAgICAgfVxuICAgIH0pO1xuICB9O1xuXG4gIGNvbnN0IGNhdGVnb3J5TmF2TGlzdCA9ICQoYCNjYXRlZ29yeU5hdkxpc3QgbGkgYWApO1xuICBjYXRlZ29yeU5hdkxpc3QuZWFjaChmdW5jdGlvbiAoaXRlbSkge1xuICAgIGNvbnN0IG5hdkxpbmsgPSAkKHRoaXMpO1xuICAgIG5hdkxpbmsub24oYGNsaWNrYCwgKGV2dCkgPT4ge1xuICAgICAgZXZ0LnByZXZlbnREZWZhdWx0KCk7XG4gICAgICBjb25zdCBuYXZMaW5rRGF0YUxpbmsgPSAkKHRoaXMpLmF0dHIoYGRhdGEtbGlua2ApO1xuICAgICAgc2Nyb2xsVG9TZWN0aW9uKG5hdkxpbmtEYXRhTGluayk7XG4gICAgfSk7XG4gIH0pO1xuXG4gIGNvbnN0IGNvbW1lbnRzRm9ybSA9ICQoYCNjb21tZW50c0Zvcm1gKTtcblxuICBpZiAoY29tbWVudHNGb3JtKSB7XG4gICAgaWYgKGNvbW1lbnRzRm9ybVswXSkge1xuICAgICAgY29tbWVudHNGb3JtWzBdLnJlc2V0KCk7XG4gICAgfVxuXG4gICAgY29tbWVudHNGb3JtLnZhbGlkYXRlKHtcbiAgICAgIHJ1bGVzOiB7XG4gICAgICAgIGNvbW1lbnQ6IHtcbiAgICAgICAgICByZXF1aXJlZDogdHJ1ZSxcbiAgICAgICAgICBtaW5sZW5ndGg6IDJcbiAgICAgICAgfVxuICAgICAgfSxcbiAgICAgIG1lc3NhZ2VzOiB7XG4gICAgICAgIGNvbW1lbnQ6IHtcbiAgICAgICAgICByZXF1aXJlZDogYNCX0LDQv9C+0LvQvdC40YLQtSDQv9C+0LvQtSFgLFxuICAgICAgICAgIG1pbmxlbmd0aDogYNCU0L7Qv9GD0YHRgtC40LzQviDQvNC40L3QuNC80YPQvCDQtNCy0LAg0YHQuNC80LLQvtC70LAg0L/RgNC4INCy0LLQvtC00LUg0LjQvNC10L3QuGBcbiAgICAgICAgfVxuICAgICAgfSxcbiAgICAgIHN1Ym1pdEhhbmRsZXIoZm9ybSkge1xuICAgICAgICBsZXQgY29tbWVudCA9ICQoYHRleHRhcmVhYCkudmFsKCk7XG4gICAgICAgICQuYWpheCh7XG4gICAgICAgICAgICB0eXBlOiBcIkdFVFwiLFxuICAgICAgICAgICAgdXJsOiBcIi4vYWpheC9yZXNwb25zZS5qc29uXCIsXG4gICAgICAgICAgICBkYXRhOiB7bmFtZTogYEF1dGhvcmAsIG1lc3NhZ2U6IGNvbW1lbnR9XG4gICAgICAgICAgfSkuZG9uZShmdW5jdGlvbiggbXNnICkge1xuICAgICAgICAgICAgY29uc29sZS5sb2cobXNnKTtcbiAgICAgICAgICAgIGZvcm0ucmVzZXQoKTtcbiAgICAgICAgICAgIGxldCBjb21tZW50TWVzc2FnZSA9ICQoYCNjb21tZW50TWVzc2FnZWApO1xuICAgICAgICAgICAgY29tbWVudE1lc3NhZ2UudGV4dChg0JLQsNGIINC60L7QvNC80LXQvdGC0LDRgNC40Lkg0YPRgdC/0LXRiNC90L4g0L7RgtC/0YDQsNCy0LvQtdC9YCk7XG4gICAgICAgICAgICBjb21tZW50TWVzc2FnZS5hdHRyKGBkYXRhLXN1Y2Nlc3NgLCB0cnVlKTtcbiAgICAgICAgICB9KS5mYWlsKGZ1bmN0aW9uKCkge1xuICAgICAgICAgICAgbGV0IGNvbW1lbnRNZXNzYWdlID0gJChgI2NvbW1lbnRNZXNzYWdlYCk7XG4gICAgICAgICAgICBjb21tZW50TWVzc2FnZS50ZXh0KGDQn9GA0Lgg0L7RgtC/0YDQsNCy0LrQtSDQstCw0YjQtdCz0L4g0LfQsNC/0YDQvtGB0LAg0LLQvtC30L3QuNC60LvQsCDQvtGI0LjQsdC60LBgKVxuICAgICAgICAgICAgY29uc29sZS5sb2coYFNvbWV0aGluZyB3cm9uZ2ApO1xuICAgICAgICAgICAgY29tbWVudE1lc3NhZ2UuYXR0cihgZGF0YS1zdWNjZXNzYCwgZmFsc2UpO1xuICAgICAgICAgIH0pXG4gICAgICB9XG4gICAgfSk7XG4gIH1cblxuXG59KTtcblxuLyogSW5pdGlhdGUgc2xpZGVycyAqL1xuY29uc3QgYXJ0aWNsZUNhcm91c2VsID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcihgI2FydGljbGVDYXJvdXNlbGApO1xuaWYgKGFydGljbGVDYXJvdXNlbCkge1xuICBjb25zdCBzbGlkZXIgPSB0bnMoe1xuICAgIGNvbnRhaW5lcjogYCNhcnRpY2xlQ2Fyb3VzZWxgLFxuICAgIHNsaWRlQnk6IGBwYWdlYCxcbiAgICBpdGVtczogMSxcbiAgICBjb250cm9sc0NvbnRhaW5lcjogYCNhcnRpY2xlU2xpZGVyQ29udHJvbHNgLFxuICAgIG5hdkNvbnRhaW5lcjogYCNhcnRpY2xlU2xpZGVyTmF2YCxcbiAgICBsb29wOiBmYWxzZSxcbiAgfSk7XG59XG5cbmNvbnN0IGRlc2t0b3BQcm9tb1NsaWRlciA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoYCNkZXNrdG9wUHJvbW9TbGlkZXJgKTtcbmlmIChkZXNrdG9wUHJvbW9TbGlkZXIpIHtcbiAgY29uc3QgZGVza3RvcFByb21vU2xpZGVyID0gdG5zKHtcbiAgICBjb250YWluZXI6IGAjZGVza3RvcFByb21vU2xpZGVyYCxcbiAgICBzbGlkZUJ5OiBgcGFnZWAsXG4gICAgaXRlbXM6IDEsXG4gICAgY29udHJvbHM6IGZhbHNlLFxuICAgIG5hdjogZmFsc2UsXG4gIH0pO1xufVxuXG5jb25zdCBtb2JpbGVQcm9tb1NsaWRlciA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoYCNtb2JpbGVQcm9tb1NsaWRlcmApO1xuaWYgKG1vYmlsZVByb21vU2xpZGVyKSB7XG4gIGNvbnN0IG1vYmlsZVByb21vU2xpZGVyID0gdG5zKHtcbiAgICBjb250YWluZXI6IGAjbW9iaWxlUHJvbW9TbGlkZXJgLFxuICAgIHNsaWRlQnk6IGBwYWdlYCxcbiAgICBpdGVtczogMSxcbiAgICBjb250cm9sczogZmFsc2UsXG4gICAgbmF2OiBmYWxzZSxcbiAgfSk7XG59XG5cbmNvbnN0IG1haW5Qcm9tb1NsaWRlciA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoYCNtYWluUHJvbW9DYXJvdXNlbGApO1xuaWYgKG1haW5Qcm9tb1NsaWRlcikge1xuICBjb25zdCBtYWluUHJvbW9TbGlkZXIgPSB0bnMoe1xuICAgIGNvbnRhaW5lcjogYCNtYWluUHJvbW9DYXJvdXNlbGAsXG4gICAgc2xpZGVCeTogYHBhZ2VgLFxuICAgIGl0ZW1zOiAxLFxuICAgIGNvbnRyb2xzOiBmYWxzZSxcbiAgICBuYXY6IGZhbHNlLFxuICB9KTtcbn1cblxuLyogR2VuZXJhdGUgcmFuZG9tIElEICovXG5cbmNvbnN0IGdlbmVyYXRlUmFuZG9tSWQgPSAobGVuZ3RoKSA9PiB7XG4gIGNvbnN0IGxldHRlcnMgPSBgMDEyMzQ1Njc4OUFCQ0RFRkdISUpLTE1OT1BRUlNUVVZXWFRaYWJjZGVmZ2hpa2xtbm9wcXJzdHV2d3h5emAuc3BsaXQoYGApO1xuXG4gIGlmICghbGVuZ3RoKSB7XG4gICAgbGVuZ3RoID0gTWF0aC5mbG9vcihNYXRoLnJhbmRvbSgpICogbGV0dGVycy5sZW5ndGgpO1xuICB9XG5cbiAgbGV0IHN0ciA9IGBgO1xuXG4gIGZvciAobGV0IGkgPSAwOyBpIDwgbGVuZ3RoOyBpKyspIHtcbiAgICBzdHIgKz0gbGV0dGVyc1tNYXRoLmZsb29yKE1hdGgucmFuZG9tKCkgKiBsZXR0ZXJzLmxlbmd0aCldO1xuICB9XG4gIHJldHVybiBzdHI7XG59O1xuXG4vKiBQb3N0IGJvb2ttYXJrIGNsaWNrICovXG5cbmNvbnN0IGFydGljbGUgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKGAuYXJ0aWNsZWApO1xuY29uc3QgcG9zdEJvb2ttYXJrID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcihgLnBvc3QtYm9va21hcmtgKTtcbmNvbnN0IHBvc3RCb29rbWFya01vYiA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoYC5wb3N0LWJvb2ttYXJrLS1tb2JgKTtcblxuaWYgKGFydGljbGUpIHtcbiAgYXJ0aWNsZS5zZXRBdHRyaWJ1dGUoYGRhdGEtaWRgLCBnZW5lcmF0ZVJhbmRvbUlkKDgpKTtcbn1cblxuZnVuY3Rpb24gc2V0Q29va2llKG5hbWUsIHZhbHVlLCBvcHRpb25zID0ge30pIHtcblxuICBvcHRpb25zID0ge1xuICAgIHBhdGg6ICcvJyxcbiAgICAuLi5vcHRpb25zXG4gIH07XG5cbiAgaWYgKG9wdGlvbnMuZXhwaXJlcyBpbnN0YW5jZW9mIERhdGUpIHtcbiAgICBvcHRpb25zLmV4cGlyZXMgPSBvcHRpb25zLmV4cGlyZXMudG9VVENTdHJpbmcoKTtcbiAgfVxuXG4gIGxldCB1cGRhdGVkQ29va2llID0gZW5jb2RlVVJJQ29tcG9uZW50KG5hbWUpICsgXCI9XCIgKyBlbmNvZGVVUklDb21wb25lbnQodmFsdWUpO1xuXG4gIGZvciAobGV0IG9wdGlvbktleSBpbiBvcHRpb25zKSB7XG4gICAgdXBkYXRlZENvb2tpZSArPSBcIjsgXCIgKyBvcHRpb25LZXk7XG4gICAgbGV0IG9wdGlvblZhbHVlID0gb3B0aW9uc1tvcHRpb25LZXldO1xuICAgIGlmIChvcHRpb25WYWx1ZSAhPT0gdHJ1ZSkge1xuICAgICAgdXBkYXRlZENvb2tpZSArPSBcIj1cIiArIG9wdGlvblZhbHVlO1xuICAgIH1cbiAgfVxuXG4gIGRvY3VtZW50LmNvb2tpZSA9IHVwZGF0ZWRDb29raWU7XG59XG5cbmZ1bmN0aW9uIGdldENvb2tpZShuYW1lKSB7XG4gIHZhciBtYXRjaGVzID0gZG9jdW1lbnQuY29va2llLm1hdGNoKG5ldyBSZWdFeHAoXG4gICAgXCIoPzpefDsgKVwiICsgbmFtZS5yZXBsYWNlKC8oW1xcLiQ/Knx7fVxcKFxcKVxcW1xcXVxcXFxcXC9cXCteXSkvZywgJ1xcXFwkMScpICsgXCI9KFteO10qKVwiXG4gICkpO1xuICByZXR1cm4gbWF0Y2hlcyA/IGRlY29kZVVSSUNvbXBvbmVudChtYXRjaGVzWzFdKSA6ICdbXSc7XG59XG5cbmZ1bmN0aW9uIGRlbGV0ZUNvb2tpZShuYW1lKSB7XG4gIHNldENvb2tpZShuYW1lLCBcIlwiLCB7XG4gICAgJ21heC1hZ2UnOiAtMVxuICB9KVxufVxuXG4vKiBXb3JraW5nIHdpdGggY29va2llcyBvbiBib29rbWFya3MgKi9cblxuaWYgKHBvc3RCb29rbWFyaykge1xuICBwb3N0Qm9va21hcmsuYWRkRXZlbnRMaXN0ZW5lcihgY2xpY2tgLCAoZXZ0KT0+e1xuICAgIGV2dC5wcmV2ZW50RGVmYXVsdCgpO1xuXG4gICAgbGV0IGFydGljbGVJZCA9IGFydGljbGUuZ2V0QXR0cmlidXRlKGBkYXRhLWlkYCk7XG5cbiAgICBsZXQgc3RhdGUgPSAwO1xuXG4gICAgcG9zdEJvb2ttYXJrLmNsYXNzTGlzdC50b2dnbGUoJ3Bvc3QtYm9va21hcmstLWFjdGl2ZScpO1xuICAgIHBvc3RCb29rbWFyay50b2dnbGVBdHRyaWJ1dGUoYGVuYWJsZWRgKTtcblxuICAgIGlmIChwb3N0Qm9va21hcmsuY2xhc3NMaXN0LmNvbnRhaW5zKCdwb3N0LWJvb2ttYXJrLS1hY3RpdmUnKSkge1xuICAgICAgc3RhdGUgPSAxO1xuICAgIH1cbiAgICBsZXQgYXJ0aWNsZXNMaXN0ID0gSlNPTi5wYXJzZShnZXRDb29raWUoJ2FydGljbGVzTGlzdCcpKSB8fCBbXTtcblxuICAgIGlmIChzdGF0ZSAmJiBhcnRpY2xlc0xpc3QuaW5kZXhPZihhcnRpY2xlSWQpID09IC0xKSB7XG4gICAgICBhcnRpY2xlc0xpc3QucHVzaChhcnRpY2xlSWQpO1xuICAgIH0gZWxzZSBpZiAoIXN0YXRlICYmIGFydGljbGVzTGlzdC5pbmRleE9mKGFydGljbGVJZCkgIT0gLTEpIHtcbiAgICAgIGFydGljbGVzTGlzdCA9IGFydGljbGVzTGlzdC5maWx0ZXIoaXRlbSA9PiBpdGVtICE9IGFydGljbGVJZCk7XG4gICAgfVxuICAgIHNldENvb2tpZSgnYXJ0aWNsZXNMaXN0JywgSlNPTi5zdHJpbmdpZnkoYXJ0aWNsZXNMaXN0KSwgeydtYXgtYWdlJzogMzYwMCwgZXhwaXJlczogYFR1ZSwgMTkgSmFuIDIwMzggMDM6MTQ6MDcgR01UYH0pO1xuICB9KTtcbn1cblxuaWYgKHBvc3RCb29rbWFya01vYikge1xuICBwb3N0Qm9va21hcmtNb2IuYWRkRXZlbnRMaXN0ZW5lcihgY2xpY2tgLCAoZXZ0KT0+e1xuICAgIGV2dC5wcmV2ZW50RGVmYXVsdCgpO1xuXG4gICAgbGV0IGFydGljbGVJZCA9IGFydGljbGUuZ2V0QXR0cmlidXRlKGBkYXRhLWlkYCk7XG4gICAgbGV0IGFydGljbGVDb29raWVOYW1lID0gYGRhdGEtaWRgO1xuICAgIGxldCBwb3N0Qm9va21hcmtJY29uID0gcG9zdEJvb2ttYXJrTW9iLnF1ZXJ5U2VsZWN0b3IoYGltZ2ApO1xuXG4gICAgaWYgKHBvc3RCb29rbWFya0ljb24uZ2V0QXR0cmlidXRlKGBzcmNgKSA9PT0gYGltZy9pY29ucy9pY29uLWJvb2ttYXJrLnN2Z2ApIHtcbiAgICAgIHBvc3RCb29rbWFya0ljb24uc2V0QXR0cmlidXRlKGBzcmNgLCBgaW1nL2ljb25zL2ljb24tYm9va21hcmstZmlsbC5zdmdgKTtcbiAgICB9IGVsc2Uge1xuICAgICAgcG9zdEJvb2ttYXJrSWNvbi5zZXRBdHRyaWJ1dGUoYHNyY2AsIGBpbWcvaWNvbnMvaWNvbi1ib29rbWFyay5zdmdgKTtcbiAgICB9XG5cbiAgICBsZXQgY29va2llRGF0ZSA9IG5ldyBEYXRlKCk7XG4gICAgY29va2llRGF0ZS5zZXRUaW1lKGNvb2tpZURhdGUuZ2V0VGltZSgpICsgKDE0NDAgKiA2MCAqIDEwMDApKTtcbiAgICBsZXQgZGF0ZSA9IGNvb2tpZURhdGUudG9VVENTdHJpbmcoKTtcblxuICAgIGRvY3VtZW50LmNvb2tpZSA9IGVuY29kZVVSSUNvbXBvbmVudChhcnRpY2xlQ29va2llTmFtZSkgKyBgPWAgKyBlbmNvZGVVUklDb21wb25lbnQoYXJ0aWNsZUlkKSArIGBleHBpcmVzPWAgKyBkYXRlO1xuICB9KTtcbn1cblxuIl0sImZpbGUiOiJtYWluLmpzIn0=
