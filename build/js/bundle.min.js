"use strict";
jQuery(function () {

  /* Handle scroll */

  $(window).scroll(() => {
    const scrollPosition = $(window).scrollTop();
    // const articlePoster = $(`#articlePoster`);
    const header = $(`#mainHeader`);
    const windowWidth = $(window).width();
    // if (articlePoster) {
    //   if (windowWidth >= 768) {
    //     if (scrollPosition > 350) {
    //       articlePoster.addClass(`article__poster--smallHeight`);
    //     } else {
    //       articlePoster.removeClass(`article__poster--smallHeight`);
    //     }
    //   }
    //   if (windowWidth < 768) {
    //     if (scrollPosition > 350) {
    //       articlePoster.addClass(`article__poster--smallHeight`);
    //     } else {
    //       articlePoster.removeClass(`article__poster--smallHeight`);
    //     }
    //   }
    // }
    if (header) {
      if (windowWidth >= 768) {
        if (scrollPosition > 150) {
          header.addClass(`header--smallHeight`);
        } else {
          header.removeClass(`header--smallHeight`);
        }
      }
      if (windowWidth < 768) {
        if (scrollPosition > 150) {
          header.addClass(`header--smallHeight`);
        } else {
          header.removeClass(`header--smallHeight`);
        }
      }
    }
  });

  /* Handle comments like buttons */

  const mobileNav = $(`#headerMobileNav`);
  const mobileMenu = $(`#headerMobileMenu`);
  const mobileClose = $(`#headerMobileClose`);
  const mobileSubscribe = $(`#headerMobileSubscribe`);
  const footerSubscribeForm = $(`#footerSubscribe`);
  const headerSubscribeButton = $(`#headerSubscribeButton`);
  const postCommentsLink = $(`#postCommentsLink`);
  const postCommentsBlock = $(`#postComments`);

  const checkCommentLike = (item) => {
    const commentLikeButton = item.find(`.comments__like__btn--like`);
    const commentDisLikeButton = item.find(`.comments__like__btn--dislike`);
    const commentCount = item.find(`.comments__views`);
    let commentCountValue = +commentCount.attr(`data-count`);


    commentLikeButton.on(`click`, (evt) => {
      evt.preventDefault();
      commentDisLikeButton.removeClass(`comments__like__btn--active`);
      commentLikeButton.addClass(`comments__like__btn--active`);
      commentCountValue += 1;
      commentCount.text(`+${commentCountValue}`);
      commentCount.attr(`data-count`, commentCountValue);

      let commentId = item.attr(`data-commentid`);
      let commentURL = item.attr(`data-commentURL`);

      $.ajax({
        method: `GET`,
        url: commentURL,
        data: {
          commentId,
          commentCount: commentCountValue
        },
        success(response) {
          console.log(response);
        },
        error(response) {
          console.log(response);
        }
      });
    });
    commentDisLikeButton.on(`click`, (evt) => {
      evt.preventDefault();
      commentDisLikeButton.addClass(`comments__like__btn--active`);
      commentLikeButton.removeClass(`comments__like__btn--active`);
      commentCountValue -= 1;
      commentCount.text(`+${commentCountValue}`);
      commentCount.attr(`data-count`, commentCountValue);

      let commentId = item.attr(`data-commentid`);
      let commentURL = item.attr(`data-commentURL`);

      $.ajax({
        method: `GET`,
        url: commentURL,
        data: {
          commentId,
          commentCount: commentCountValue
        },
        success(response) {
          console.log(response);
        },
        error(response) {
          console.log(response);
        }
      });
    });
  };

  const commentBlocks = $(`.comments__block:not(.comments__block__form)`);
  commentBlocks.each(function () {
    const commentItems = $(this).find(`.comments__item`);
    commentItems.each(function () {
      checkCommentLike($(this));
      $(this).attr(`data-commentid`, `comment-${generateRandomId(8)}`);
      $(this).attr(`data-commenturl`, `http://localhost:3000/ajax/response.json`);
    });
  });

  mobileNav.on(`click`, (evt) => {
    evt.preventDefault();
    mobileMenu.addClass(`show`);
  });
  mobileClose.on(`click`, (evt) => {
    evt.preventDefault();
    mobileMenu.removeClass(`show`);
  });
  headerSubscribeButton.on(`click`, (evt) => {
    evt.preventDefault();
    footerSubscribeForm[0].scrollIntoView({block: `start`, behavior: `smooth`});
  });

  if (mobileSubscribe) {
    mobileSubscribe.on(`click`, (evt) => {
      evt.preventDefault();
      footerSubscribeForm[0].scrollIntoView({block: `start`, behavior: `smooth`});
      mobileMenu.removeClass(`show`);
    });
  }

  postCommentsLink.on(`click`, (evt) => {
    evt.preventDefault();
    postCommentsBlock[0].scrollIntoView({block: `start`, behavior: `smooth`});
  });

  const scrollToSection = (dataLink) => {
    const sectionsWithData = $(`section.short-section`);
    sectionsWithData.each(function () {
      const sectionWithData = $(this);
      if (dataLink === sectionWithData.attr(`data-id`)) {
        sectionWithData[0].scrollIntoView({block: `start`, behavior: `smooth`});
      }
    });
  };

  const categoryNavList = $(`#categoryNavList li a`);
  categoryNavList.each(function (item) {
    const navLink = $(this);
    navLink.on(`click`, (evt) => {
      evt.preventDefault();
      const navLinkDataLink = $(this).attr(`data-link`);
      scrollToSection(navLinkDataLink);
    });
  });

  const commentsForm = $(`#commentsForm`);
  commentsForm[0].reset();

  commentsForm.validate({
    rules: {
      comment: {
        required: true,
        minlength: 2
      }
    },
    messages: {
      comment: {
        required: `Заполните поле!`,
        minlength: `Допустимо минимум два символа при вводе имени`
      }
    },
    submitHandler(form) {
      let comment = $(`textarea`).val();
      $.ajax({
          type: "GET",
          url: "/ajax/response.json",
          data: {name: `Author`, message: comment}
        }).done(function( msg ) {
          console.log(msg);
          form.reset();
          let commentMessage = $(`#commentMessage`);
          commentMessage.text(`Ваш комментарий успешно отправлен`);
          commentMessage.attr(`data-success`, true);
        }).fail(function() {
          let commentMessage = $(`#commentMessage`);
          commentMessage.text(`При отправке вашего запроса возникла ошибка`)
          console.log(`Something wrong`);
          commentMessage.attr(`data-success`, false);
        })
    }
  });

});

/* Initiate sliders */
const articleCarousel = document.querySelector(`#articleCarousel`);
if (articleCarousel) {
  const slider = tns({
    container: `#articleCarousel`,
    slideBy: `page`,
    items: 1,
    controlsContainer: `#articleSliderControls`,
    navContainer: `#articleSliderNav`,
    loop: false,
  });
}

const desktopPromoSlider = document.querySelector(`#desktopPromoSlider`);
if (desktopPromoSlider) {
  const desktopPromoSlider = tns({
    container: `#desktopPromoSlider`,
    slideBy: `page`,
    items: 1,
    controls: false,
    nav: false,
  });
}

const mobilePromoSlider = document.querySelector(`#mobilePromoSlider`);
if (mobilePromoSlider) {
  const mobilePromoSlider = tns({
    container: `#mobilePromoSlider`,
    slideBy: `page`,
    items: 1,
    controls: false,
    nav: false,
  });
}

const mainPromoSlider = document.querySelector(`#mainPromoCarousel`);
if (mainPromoSlider) {
  const mainPromoSlider = tns({
    container: `#mainPromoCarousel`,
    slideBy: `page`,
    items: 1,
    controls: false,
    nav: false,
  });
}

/* Generate random ID */

const generateRandomId = (length) => {
  const letters = `0123456789ABCDEFGHIJKLMNOPQRSTUVWXTZabcdefghiklmnopqrstuvwxyz`.split(``);

  if (!length) {
    length = Math.floor(Math.random() * letters.length);
  }

  let str = ``;

  for (let i = 0; i < length; i++) {
    str += letters[Math.floor(Math.random() * letters.length)];
  }
  return str;
};

/* Post bookmark click */

const article = document.querySelector(`.article`);
const postBookmark = document.querySelector(`.post-bookmark`);
const postBookmarkMob = document.querySelector(`.post-bookmark--mob`);

if (article) {
  article.setAttribute(`data-id`, generateRandomId(8));
}

function setCookie(name, value, options = {}) {

  options = {
    path: '/',
    ...options
  };

  if (options.expires instanceof Date) {
    options.expires = options.expires.toUTCString();
  }

  let updatedCookie = encodeURIComponent(name) + "=" + encodeURIComponent(value);

  for (let optionKey in options) {
    updatedCookie += "; " + optionKey;
    let optionValue = options[optionKey];
    if (optionValue !== true) {
      updatedCookie += "=" + optionValue;
    }
  }

  document.cookie = updatedCookie;
}

function getCookie(name) {
  var matches = document.cookie.match(new RegExp(
    "(?:^|; )" + name.replace(/([\.$?*|{}\(\)\[\]\\\/\+^])/g, '\\$1') + "=([^;]*)"
  ));
  return matches ? decodeURIComponent(matches[1]) : '[]';
}

function deleteCookie(name) {
  setCookie(name, "", {
    'max-age': -1
  })
}

function checkCookieInArray(list, cookie) {
  let result = undefined;

  for (let item of list) {
    if (item[1] === cookie[1]) {
      result = true;
      console.log(`In array`);
    } else {
      result = false;
      console.log(`Out of array`);
    }
  }

  return result;
}

/* Working with cookie array */

let articleCookies = [];

if (postBookmark) {
  postBookmark.addEventListener(`click`, (evt)=>{
    evt.preventDefault();

    let articleId = article.getAttribute(`data-id`);
    let postBookmarkIcon = postBookmark.querySelector(`img`);

    if (postBookmarkIcon.getAttribute(`src`) === `img/icons/icon-bookmark.svg`) {
      postBookmarkIcon.setAttribute(`src`, `img/icons/icon-bookmark-fill.svg`);
    } else {
      postBookmarkIcon.setAttribute(`src`, `img/icons/icon-bookmark.svg`);
    }

    let newCookie = [`dataId`, articleId];
    let articlesList = JSON.parse(getCookie('articlesList')) || [];

    const filterResult = checkCookieInArray(articlesList, newCookie);
    console.log(filterResult)

    if (filterResult) {
      console.log(`removing from array...`);
      const filteredArray = articlesList.filter((item) => {
        if (item[1] !== newCookie[1]) {
          return item;
        }
      });
      deleteCookie(`articlesList`);
      console.log(`Filtered array...`, filteredArray);
      setCookie('articlesList', JSON.stringify(filteredArray), {'max-age': 3600, expires: `Tue, 19 Jan 2038 03:14:07 GMT`});
    } else {
      console.log(`Add to array...`);
      articlesList = articlesList.concat([newCookie]);
      console.log(`Array with new id...`, articlesList);
      setCookie('articlesList', JSON.stringify(articlesList), {'max-age': 3600, expires: `Tue, 19 Jan 2038 03:14:07 GMT`});
    }
  });
}

if (postBookmarkMob) {
  postBookmarkMob.addEventListener(`click`, (evt)=>{
    evt.preventDefault();

    let articleId = article.getAttribute(`data-id`);
    let articleCookieName = `data-id`;
    let postBookmarkIcon = postBookmarkMob.querySelector(`img`);

    if (postBookmarkIcon.getAttribute(`src`) === `img/icons/icon-bookmark.svg`) {
      postBookmarkIcon.setAttribute(`src`, `img/icons/icon-bookmark-fill.svg`);
    } else {
      postBookmarkIcon.setAttribute(`src`, `img/icons/icon-bookmark.svg`);
    }

    let cookieDate = new Date();
    cookieDate.setTime(cookieDate.getTime() + (1440 * 60 * 1000));
    let date = cookieDate.toUTCString();

    document.cookie = encodeURIComponent(articleCookieName) + `=` + encodeURIComponent(articleId) + `expires=` + date;
  });
}

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiIiwic291cmNlcyI6WyJtYWluLmpzIl0sInNvdXJjZXNDb250ZW50IjpbIlwidXNlIHN0cmljdFwiO1xualF1ZXJ5KGZ1bmN0aW9uICgpIHtcblxuICAvKiBIYW5kbGUgc2Nyb2xsICovXG5cbiAgJCh3aW5kb3cpLnNjcm9sbCgoKSA9PiB7XG4gICAgY29uc3Qgc2Nyb2xsUG9zaXRpb24gPSAkKHdpbmRvdykuc2Nyb2xsVG9wKCk7XG4gICAgLy8gY29uc3QgYXJ0aWNsZVBvc3RlciA9ICQoYCNhcnRpY2xlUG9zdGVyYCk7XG4gICAgY29uc3QgaGVhZGVyID0gJChgI21haW5IZWFkZXJgKTtcbiAgICBjb25zdCB3aW5kb3dXaWR0aCA9ICQod2luZG93KS53aWR0aCgpO1xuICAgIC8vIGlmIChhcnRpY2xlUG9zdGVyKSB7XG4gICAgLy8gICBpZiAod2luZG93V2lkdGggPj0gNzY4KSB7XG4gICAgLy8gICAgIGlmIChzY3JvbGxQb3NpdGlvbiA+IDM1MCkge1xuICAgIC8vICAgICAgIGFydGljbGVQb3N0ZXIuYWRkQ2xhc3MoYGFydGljbGVfX3Bvc3Rlci0tc21hbGxIZWlnaHRgKTtcbiAgICAvLyAgICAgfSBlbHNlIHtcbiAgICAvLyAgICAgICBhcnRpY2xlUG9zdGVyLnJlbW92ZUNsYXNzKGBhcnRpY2xlX19wb3N0ZXItLXNtYWxsSGVpZ2h0YCk7XG4gICAgLy8gICAgIH1cbiAgICAvLyAgIH1cbiAgICAvLyAgIGlmICh3aW5kb3dXaWR0aCA8IDc2OCkge1xuICAgIC8vICAgICBpZiAoc2Nyb2xsUG9zaXRpb24gPiAzNTApIHtcbiAgICAvLyAgICAgICBhcnRpY2xlUG9zdGVyLmFkZENsYXNzKGBhcnRpY2xlX19wb3N0ZXItLXNtYWxsSGVpZ2h0YCk7XG4gICAgLy8gICAgIH0gZWxzZSB7XG4gICAgLy8gICAgICAgYXJ0aWNsZVBvc3Rlci5yZW1vdmVDbGFzcyhgYXJ0aWNsZV9fcG9zdGVyLS1zbWFsbEhlaWdodGApO1xuICAgIC8vICAgICB9XG4gICAgLy8gICB9XG4gICAgLy8gfVxuICAgIGlmIChoZWFkZXIpIHtcbiAgICAgIGlmICh3aW5kb3dXaWR0aCA+PSA3NjgpIHtcbiAgICAgICAgaWYgKHNjcm9sbFBvc2l0aW9uID4gMTUwKSB7XG4gICAgICAgICAgaGVhZGVyLmFkZENsYXNzKGBoZWFkZXItLXNtYWxsSGVpZ2h0YCk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgaGVhZGVyLnJlbW92ZUNsYXNzKGBoZWFkZXItLXNtYWxsSGVpZ2h0YCk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIGlmICh3aW5kb3dXaWR0aCA8IDc2OCkge1xuICAgICAgICBpZiAoc2Nyb2xsUG9zaXRpb24gPiAxNTApIHtcbiAgICAgICAgICBoZWFkZXIuYWRkQ2xhc3MoYGhlYWRlci0tc21hbGxIZWlnaHRgKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBoZWFkZXIucmVtb3ZlQ2xhc3MoYGhlYWRlci0tc21hbGxIZWlnaHRgKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgfSk7XG5cbiAgLyogSGFuZGxlIGNvbW1lbnRzIGxpa2UgYnV0dG9ucyAqL1xuXG4gIGNvbnN0IG1vYmlsZU5hdiA9ICQoYCNoZWFkZXJNb2JpbGVOYXZgKTtcbiAgY29uc3QgbW9iaWxlTWVudSA9ICQoYCNoZWFkZXJNb2JpbGVNZW51YCk7XG4gIGNvbnN0IG1vYmlsZUNsb3NlID0gJChgI2hlYWRlck1vYmlsZUNsb3NlYCk7XG4gIGNvbnN0IG1vYmlsZVN1YnNjcmliZSA9ICQoYCNoZWFkZXJNb2JpbGVTdWJzY3JpYmVgKTtcbiAgY29uc3QgZm9vdGVyU3Vic2NyaWJlRm9ybSA9ICQoYCNmb290ZXJTdWJzY3JpYmVgKTtcbiAgY29uc3QgaGVhZGVyU3Vic2NyaWJlQnV0dG9uID0gJChgI2hlYWRlclN1YnNjcmliZUJ1dHRvbmApO1xuICBjb25zdCBwb3N0Q29tbWVudHNMaW5rID0gJChgI3Bvc3RDb21tZW50c0xpbmtgKTtcbiAgY29uc3QgcG9zdENvbW1lbnRzQmxvY2sgPSAkKGAjcG9zdENvbW1lbnRzYCk7XG5cbiAgY29uc3QgY2hlY2tDb21tZW50TGlrZSA9IChpdGVtKSA9PiB7XG4gICAgY29uc3QgY29tbWVudExpa2VCdXR0b24gPSBpdGVtLmZpbmQoYC5jb21tZW50c19fbGlrZV9fYnRuLS1saWtlYCk7XG4gICAgY29uc3QgY29tbWVudERpc0xpa2VCdXR0b24gPSBpdGVtLmZpbmQoYC5jb21tZW50c19fbGlrZV9fYnRuLS1kaXNsaWtlYCk7XG4gICAgY29uc3QgY29tbWVudENvdW50ID0gaXRlbS5maW5kKGAuY29tbWVudHNfX3ZpZXdzYCk7XG4gICAgbGV0IGNvbW1lbnRDb3VudFZhbHVlID0gK2NvbW1lbnRDb3VudC5hdHRyKGBkYXRhLWNvdW50YCk7XG5cblxuICAgIGNvbW1lbnRMaWtlQnV0dG9uLm9uKGBjbGlja2AsIChldnQpID0+IHtcbiAgICAgIGV2dC5wcmV2ZW50RGVmYXVsdCgpO1xuICAgICAgY29tbWVudERpc0xpa2VCdXR0b24ucmVtb3ZlQ2xhc3MoYGNvbW1lbnRzX19saWtlX19idG4tLWFjdGl2ZWApO1xuICAgICAgY29tbWVudExpa2VCdXR0b24uYWRkQ2xhc3MoYGNvbW1lbnRzX19saWtlX19idG4tLWFjdGl2ZWApO1xuICAgICAgY29tbWVudENvdW50VmFsdWUgKz0gMTtcbiAgICAgIGNvbW1lbnRDb3VudC50ZXh0KGArJHtjb21tZW50Q291bnRWYWx1ZX1gKTtcbiAgICAgIGNvbW1lbnRDb3VudC5hdHRyKGBkYXRhLWNvdW50YCwgY29tbWVudENvdW50VmFsdWUpO1xuXG4gICAgICBsZXQgY29tbWVudElkID0gaXRlbS5hdHRyKGBkYXRhLWNvbW1lbnRpZGApO1xuICAgICAgbGV0IGNvbW1lbnRVUkwgPSBpdGVtLmF0dHIoYGRhdGEtY29tbWVudFVSTGApO1xuXG4gICAgICAkLmFqYXgoe1xuICAgICAgICBtZXRob2Q6IGBHRVRgLFxuICAgICAgICB1cmw6IGNvbW1lbnRVUkwsXG4gICAgICAgIGRhdGE6IHtcbiAgICAgICAgICBjb21tZW50SWQsXG4gICAgICAgICAgY29tbWVudENvdW50OiBjb21tZW50Q291bnRWYWx1ZVxuICAgICAgICB9LFxuICAgICAgICBzdWNjZXNzKHJlc3BvbnNlKSB7XG4gICAgICAgICAgY29uc29sZS5sb2cocmVzcG9uc2UpO1xuICAgICAgICB9LFxuICAgICAgICBlcnJvcihyZXNwb25zZSkge1xuICAgICAgICAgIGNvbnNvbGUubG9nKHJlc3BvbnNlKTtcbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgfSk7XG4gICAgY29tbWVudERpc0xpa2VCdXR0b24ub24oYGNsaWNrYCwgKGV2dCkgPT4ge1xuICAgICAgZXZ0LnByZXZlbnREZWZhdWx0KCk7XG4gICAgICBjb21tZW50RGlzTGlrZUJ1dHRvbi5hZGRDbGFzcyhgY29tbWVudHNfX2xpa2VfX2J0bi0tYWN0aXZlYCk7XG4gICAgICBjb21tZW50TGlrZUJ1dHRvbi5yZW1vdmVDbGFzcyhgY29tbWVudHNfX2xpa2VfX2J0bi0tYWN0aXZlYCk7XG4gICAgICBjb21tZW50Q291bnRWYWx1ZSAtPSAxO1xuICAgICAgY29tbWVudENvdW50LnRleHQoYCske2NvbW1lbnRDb3VudFZhbHVlfWApO1xuICAgICAgY29tbWVudENvdW50LmF0dHIoYGRhdGEtY291bnRgLCBjb21tZW50Q291bnRWYWx1ZSk7XG5cbiAgICAgIGxldCBjb21tZW50SWQgPSBpdGVtLmF0dHIoYGRhdGEtY29tbWVudGlkYCk7XG4gICAgICBsZXQgY29tbWVudFVSTCA9IGl0ZW0uYXR0cihgZGF0YS1jb21tZW50VVJMYCk7XG5cbiAgICAgICQuYWpheCh7XG4gICAgICAgIG1ldGhvZDogYEdFVGAsXG4gICAgICAgIHVybDogY29tbWVudFVSTCxcbiAgICAgICAgZGF0YToge1xuICAgICAgICAgIGNvbW1lbnRJZCxcbiAgICAgICAgICBjb21tZW50Q291bnQ6IGNvbW1lbnRDb3VudFZhbHVlXG4gICAgICAgIH0sXG4gICAgICAgIHN1Y2Nlc3MocmVzcG9uc2UpIHtcbiAgICAgICAgICBjb25zb2xlLmxvZyhyZXNwb25zZSk7XG4gICAgICAgIH0sXG4gICAgICAgIGVycm9yKHJlc3BvbnNlKSB7XG4gICAgICAgICAgY29uc29sZS5sb2cocmVzcG9uc2UpO1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgICB9KTtcbiAgfTtcblxuICBjb25zdCBjb21tZW50QmxvY2tzID0gJChgLmNvbW1lbnRzX19ibG9jazpub3QoLmNvbW1lbnRzX19ibG9ja19fZm9ybSlgKTtcbiAgY29tbWVudEJsb2Nrcy5lYWNoKGZ1bmN0aW9uICgpIHtcbiAgICBjb25zdCBjb21tZW50SXRlbXMgPSAkKHRoaXMpLmZpbmQoYC5jb21tZW50c19faXRlbWApO1xuICAgIGNvbW1lbnRJdGVtcy5lYWNoKGZ1bmN0aW9uICgpIHtcbiAgICAgIGNoZWNrQ29tbWVudExpa2UoJCh0aGlzKSk7XG4gICAgICAkKHRoaXMpLmF0dHIoYGRhdGEtY29tbWVudGlkYCwgYGNvbW1lbnQtJHtnZW5lcmF0ZVJhbmRvbUlkKDgpfWApO1xuICAgICAgJCh0aGlzKS5hdHRyKGBkYXRhLWNvbW1lbnR1cmxgLCBgaHR0cDovL2xvY2FsaG9zdDozMDAwL2FqYXgvcmVzcG9uc2UuanNvbmApO1xuICAgIH0pO1xuICB9KTtcblxuICBtb2JpbGVOYXYub24oYGNsaWNrYCwgKGV2dCkgPT4ge1xuICAgIGV2dC5wcmV2ZW50RGVmYXVsdCgpO1xuICAgIG1vYmlsZU1lbnUuYWRkQ2xhc3MoYHNob3dgKTtcbiAgfSk7XG4gIG1vYmlsZUNsb3NlLm9uKGBjbGlja2AsIChldnQpID0+IHtcbiAgICBldnQucHJldmVudERlZmF1bHQoKTtcbiAgICBtb2JpbGVNZW51LnJlbW92ZUNsYXNzKGBzaG93YCk7XG4gIH0pO1xuICBoZWFkZXJTdWJzY3JpYmVCdXR0b24ub24oYGNsaWNrYCwgKGV2dCkgPT4ge1xuICAgIGV2dC5wcmV2ZW50RGVmYXVsdCgpO1xuICAgIGZvb3RlclN1YnNjcmliZUZvcm1bMF0uc2Nyb2xsSW50b1ZpZXcoe2Jsb2NrOiBgc3RhcnRgLCBiZWhhdmlvcjogYHNtb290aGB9KTtcbiAgfSk7XG5cbiAgaWYgKG1vYmlsZVN1YnNjcmliZSkge1xuICAgIG1vYmlsZVN1YnNjcmliZS5vbihgY2xpY2tgLCAoZXZ0KSA9PiB7XG4gICAgICBldnQucHJldmVudERlZmF1bHQoKTtcbiAgICAgIGZvb3RlclN1YnNjcmliZUZvcm1bMF0uc2Nyb2xsSW50b1ZpZXcoe2Jsb2NrOiBgc3RhcnRgLCBiZWhhdmlvcjogYHNtb290aGB9KTtcbiAgICAgIG1vYmlsZU1lbnUucmVtb3ZlQ2xhc3MoYHNob3dgKTtcbiAgICB9KTtcbiAgfVxuXG4gIHBvc3RDb21tZW50c0xpbmsub24oYGNsaWNrYCwgKGV2dCkgPT4ge1xuICAgIGV2dC5wcmV2ZW50RGVmYXVsdCgpO1xuICAgIHBvc3RDb21tZW50c0Jsb2NrWzBdLnNjcm9sbEludG9WaWV3KHtibG9jazogYHN0YXJ0YCwgYmVoYXZpb3I6IGBzbW9vdGhgfSk7XG4gIH0pO1xuXG4gIGNvbnN0IHNjcm9sbFRvU2VjdGlvbiA9IChkYXRhTGluaykgPT4ge1xuICAgIGNvbnN0IHNlY3Rpb25zV2l0aERhdGEgPSAkKGBzZWN0aW9uLnNob3J0LXNlY3Rpb25gKTtcbiAgICBzZWN0aW9uc1dpdGhEYXRhLmVhY2goZnVuY3Rpb24gKCkge1xuICAgICAgY29uc3Qgc2VjdGlvbldpdGhEYXRhID0gJCh0aGlzKTtcbiAgICAgIGlmIChkYXRhTGluayA9PT0gc2VjdGlvbldpdGhEYXRhLmF0dHIoYGRhdGEtaWRgKSkge1xuICAgICAgICBzZWN0aW9uV2l0aERhdGFbMF0uc2Nyb2xsSW50b1ZpZXcoe2Jsb2NrOiBgc3RhcnRgLCBiZWhhdmlvcjogYHNtb290aGB9KTtcbiAgICAgIH1cbiAgICB9KTtcbiAgfTtcblxuICBjb25zdCBjYXRlZ29yeU5hdkxpc3QgPSAkKGAjY2F0ZWdvcnlOYXZMaXN0IGxpIGFgKTtcbiAgY2F0ZWdvcnlOYXZMaXN0LmVhY2goZnVuY3Rpb24gKGl0ZW0pIHtcbiAgICBjb25zdCBuYXZMaW5rID0gJCh0aGlzKTtcbiAgICBuYXZMaW5rLm9uKGBjbGlja2AsIChldnQpID0+IHtcbiAgICAgIGV2dC5wcmV2ZW50RGVmYXVsdCgpO1xuICAgICAgY29uc3QgbmF2TGlua0RhdGFMaW5rID0gJCh0aGlzKS5hdHRyKGBkYXRhLWxpbmtgKTtcbiAgICAgIHNjcm9sbFRvU2VjdGlvbihuYXZMaW5rRGF0YUxpbmspO1xuICAgIH0pO1xuICB9KTtcblxuICBjb25zdCBjb21tZW50c0Zvcm0gPSAkKGAjY29tbWVudHNGb3JtYCk7XG4gIGNvbW1lbnRzRm9ybVswXS5yZXNldCgpO1xuXG4gIGNvbW1lbnRzRm9ybS52YWxpZGF0ZSh7XG4gICAgcnVsZXM6IHtcbiAgICAgIGNvbW1lbnQ6IHtcbiAgICAgICAgcmVxdWlyZWQ6IHRydWUsXG4gICAgICAgIG1pbmxlbmd0aDogMlxuICAgICAgfVxuICAgIH0sXG4gICAgbWVzc2FnZXM6IHtcbiAgICAgIGNvbW1lbnQ6IHtcbiAgICAgICAgcmVxdWlyZWQ6IGDQl9Cw0L/QvtC70L3QuNGC0LUg0L/QvtC70LUhYCxcbiAgICAgICAgbWlubGVuZ3RoOiBg0JTQvtC/0YPRgdGC0LjQvNC+INC80LjQvdC40LzRg9C8INC00LLQsCDRgdC40LzQstC+0LvQsCDQv9GA0Lgg0LLQstC+0LTQtSDQuNC80LXQvdC4YFxuICAgICAgfVxuICAgIH0sXG4gICAgc3VibWl0SGFuZGxlcihmb3JtKSB7XG4gICAgICBsZXQgY29tbWVudCA9ICQoYHRleHRhcmVhYCkudmFsKCk7XG4gICAgICAkLmFqYXgoe1xuICAgICAgICAgIHR5cGU6IFwiR0VUXCIsXG4gICAgICAgICAgdXJsOiBcIi9hamF4L3Jlc3BvbnNlLmpzb25cIixcbiAgICAgICAgICBkYXRhOiB7bmFtZTogYEF1dGhvcmAsIG1lc3NhZ2U6IGNvbW1lbnR9XG4gICAgICAgIH0pLmRvbmUoZnVuY3Rpb24oIG1zZyApIHtcbiAgICAgICAgICBjb25zb2xlLmxvZyhtc2cpO1xuICAgICAgICAgIGZvcm0ucmVzZXQoKTtcbiAgICAgICAgICBsZXQgY29tbWVudE1lc3NhZ2UgPSAkKGAjY29tbWVudE1lc3NhZ2VgKTtcbiAgICAgICAgICBjb21tZW50TWVzc2FnZS50ZXh0KGDQktCw0Ygg0LrQvtC80LzQtdC90YLQsNGA0LjQuSDRg9GB0L/QtdGI0L3QviDQvtGC0L/RgNCw0LLQu9C10L1gKTtcbiAgICAgICAgICBjb21tZW50TWVzc2FnZS5hdHRyKGBkYXRhLXN1Y2Nlc3NgLCB0cnVlKTtcbiAgICAgICAgfSkuZmFpbChmdW5jdGlvbigpIHtcbiAgICAgICAgICBsZXQgY29tbWVudE1lc3NhZ2UgPSAkKGAjY29tbWVudE1lc3NhZ2VgKTtcbiAgICAgICAgICBjb21tZW50TWVzc2FnZS50ZXh0KGDQn9GA0Lgg0L7RgtC/0YDQsNCy0LrQtSDQstCw0YjQtdCz0L4g0LfQsNC/0YDQvtGB0LAg0LLQvtC30L3QuNC60LvQsCDQvtGI0LjQsdC60LBgKVxuICAgICAgICAgIGNvbnNvbGUubG9nKGBTb21ldGhpbmcgd3JvbmdgKTtcbiAgICAgICAgICBjb21tZW50TWVzc2FnZS5hdHRyKGBkYXRhLXN1Y2Nlc3NgLCBmYWxzZSk7XG4gICAgICAgIH0pXG4gICAgfVxuICB9KTtcblxufSk7XG5cbi8qIEluaXRpYXRlIHNsaWRlcnMgKi9cbmNvbnN0IGFydGljbGVDYXJvdXNlbCA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoYCNhcnRpY2xlQ2Fyb3VzZWxgKTtcbmlmIChhcnRpY2xlQ2Fyb3VzZWwpIHtcbiAgY29uc3Qgc2xpZGVyID0gdG5zKHtcbiAgICBjb250YWluZXI6IGAjYXJ0aWNsZUNhcm91c2VsYCxcbiAgICBzbGlkZUJ5OiBgcGFnZWAsXG4gICAgaXRlbXM6IDEsXG4gICAgY29udHJvbHNDb250YWluZXI6IGAjYXJ0aWNsZVNsaWRlckNvbnRyb2xzYCxcbiAgICBuYXZDb250YWluZXI6IGAjYXJ0aWNsZVNsaWRlck5hdmAsXG4gICAgbG9vcDogZmFsc2UsXG4gIH0pO1xufVxuXG5jb25zdCBkZXNrdG9wUHJvbW9TbGlkZXIgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKGAjZGVza3RvcFByb21vU2xpZGVyYCk7XG5pZiAoZGVza3RvcFByb21vU2xpZGVyKSB7XG4gIGNvbnN0IGRlc2t0b3BQcm9tb1NsaWRlciA9IHRucyh7XG4gICAgY29udGFpbmVyOiBgI2Rlc2t0b3BQcm9tb1NsaWRlcmAsXG4gICAgc2xpZGVCeTogYHBhZ2VgLFxuICAgIGl0ZW1zOiAxLFxuICAgIGNvbnRyb2xzOiBmYWxzZSxcbiAgICBuYXY6IGZhbHNlLFxuICB9KTtcbn1cblxuY29uc3QgbW9iaWxlUHJvbW9TbGlkZXIgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKGAjbW9iaWxlUHJvbW9TbGlkZXJgKTtcbmlmIChtb2JpbGVQcm9tb1NsaWRlcikge1xuICBjb25zdCBtb2JpbGVQcm9tb1NsaWRlciA9IHRucyh7XG4gICAgY29udGFpbmVyOiBgI21vYmlsZVByb21vU2xpZGVyYCxcbiAgICBzbGlkZUJ5OiBgcGFnZWAsXG4gICAgaXRlbXM6IDEsXG4gICAgY29udHJvbHM6IGZhbHNlLFxuICAgIG5hdjogZmFsc2UsXG4gIH0pO1xufVxuXG5jb25zdCBtYWluUHJvbW9TbGlkZXIgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKGAjbWFpblByb21vQ2Fyb3VzZWxgKTtcbmlmIChtYWluUHJvbW9TbGlkZXIpIHtcbiAgY29uc3QgbWFpblByb21vU2xpZGVyID0gdG5zKHtcbiAgICBjb250YWluZXI6IGAjbWFpblByb21vQ2Fyb3VzZWxgLFxuICAgIHNsaWRlQnk6IGBwYWdlYCxcbiAgICBpdGVtczogMSxcbiAgICBjb250cm9sczogZmFsc2UsXG4gICAgbmF2OiBmYWxzZSxcbiAgfSk7XG59XG5cbi8qIEdlbmVyYXRlIHJhbmRvbSBJRCAqL1xuXG5jb25zdCBnZW5lcmF0ZVJhbmRvbUlkID0gKGxlbmd0aCkgPT4ge1xuICBjb25zdCBsZXR0ZXJzID0gYDAxMjM0NTY3ODlBQkNERUZHSElKS0xNTk9QUVJTVFVWV1hUWmFiY2RlZmdoaWtsbW5vcHFyc3R1dnd4eXpgLnNwbGl0KGBgKTtcblxuICBpZiAoIWxlbmd0aCkge1xuICAgIGxlbmd0aCA9IE1hdGguZmxvb3IoTWF0aC5yYW5kb20oKSAqIGxldHRlcnMubGVuZ3RoKTtcbiAgfVxuXG4gIGxldCBzdHIgPSBgYDtcblxuICBmb3IgKGxldCBpID0gMDsgaSA8IGxlbmd0aDsgaSsrKSB7XG4gICAgc3RyICs9IGxldHRlcnNbTWF0aC5mbG9vcihNYXRoLnJhbmRvbSgpICogbGV0dGVycy5sZW5ndGgpXTtcbiAgfVxuICByZXR1cm4gc3RyO1xufTtcblxuLyogUG9zdCBib29rbWFyayBjbGljayAqL1xuXG5jb25zdCBhcnRpY2xlID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcihgLmFydGljbGVgKTtcbmNvbnN0IHBvc3RCb29rbWFyayA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoYC5wb3N0LWJvb2ttYXJrYCk7XG5jb25zdCBwb3N0Qm9va21hcmtNb2IgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKGAucG9zdC1ib29rbWFyay0tbW9iYCk7XG5cbmlmIChhcnRpY2xlKSB7XG4gIGFydGljbGUuc2V0QXR0cmlidXRlKGBkYXRhLWlkYCwgZ2VuZXJhdGVSYW5kb21JZCg4KSk7XG59XG5cbmZ1bmN0aW9uIHNldENvb2tpZShuYW1lLCB2YWx1ZSwgb3B0aW9ucyA9IHt9KSB7XG5cbiAgb3B0aW9ucyA9IHtcbiAgICBwYXRoOiAnLycsXG4gICAgLi4ub3B0aW9uc1xuICB9O1xuXG4gIGlmIChvcHRpb25zLmV4cGlyZXMgaW5zdGFuY2VvZiBEYXRlKSB7XG4gICAgb3B0aW9ucy5leHBpcmVzID0gb3B0aW9ucy5leHBpcmVzLnRvVVRDU3RyaW5nKCk7XG4gIH1cblxuICBsZXQgdXBkYXRlZENvb2tpZSA9IGVuY29kZVVSSUNvbXBvbmVudChuYW1lKSArIFwiPVwiICsgZW5jb2RlVVJJQ29tcG9uZW50KHZhbHVlKTtcblxuICBmb3IgKGxldCBvcHRpb25LZXkgaW4gb3B0aW9ucykge1xuICAgIHVwZGF0ZWRDb29raWUgKz0gXCI7IFwiICsgb3B0aW9uS2V5O1xuICAgIGxldCBvcHRpb25WYWx1ZSA9IG9wdGlvbnNbb3B0aW9uS2V5XTtcbiAgICBpZiAob3B0aW9uVmFsdWUgIT09IHRydWUpIHtcbiAgICAgIHVwZGF0ZWRDb29raWUgKz0gXCI9XCIgKyBvcHRpb25WYWx1ZTtcbiAgICB9XG4gIH1cblxuICBkb2N1bWVudC5jb29raWUgPSB1cGRhdGVkQ29va2llO1xufVxuXG5mdW5jdGlvbiBnZXRDb29raWUobmFtZSkge1xuICB2YXIgbWF0Y2hlcyA9IGRvY3VtZW50LmNvb2tpZS5tYXRjaChuZXcgUmVnRXhwKFxuICAgIFwiKD86Xnw7IClcIiArIG5hbWUucmVwbGFjZSgvKFtcXC4kPyp8e31cXChcXClcXFtcXF1cXFxcXFwvXFwrXl0pL2csICdcXFxcJDEnKSArIFwiPShbXjtdKilcIlxuICApKTtcbiAgcmV0dXJuIG1hdGNoZXMgPyBkZWNvZGVVUklDb21wb25lbnQobWF0Y2hlc1sxXSkgOiAnW10nO1xufVxuXG5mdW5jdGlvbiBkZWxldGVDb29raWUobmFtZSkge1xuICBzZXRDb29raWUobmFtZSwgXCJcIiwge1xuICAgICdtYXgtYWdlJzogLTFcbiAgfSlcbn1cblxuZnVuY3Rpb24gY2hlY2tDb29raWVJbkFycmF5KGxpc3QsIGNvb2tpZSkge1xuICBsZXQgcmVzdWx0ID0gdW5kZWZpbmVkO1xuXG4gIGZvciAobGV0IGl0ZW0gb2YgbGlzdCkge1xuICAgIGlmIChpdGVtWzFdID09PSBjb29raWVbMV0pIHtcbiAgICAgIHJlc3VsdCA9IHRydWU7XG4gICAgICBjb25zb2xlLmxvZyhgSW4gYXJyYXlgKTtcbiAgICB9IGVsc2Uge1xuICAgICAgcmVzdWx0ID0gZmFsc2U7XG4gICAgICBjb25zb2xlLmxvZyhgT3V0IG9mIGFycmF5YCk7XG4gICAgfVxuICB9XG5cbiAgcmV0dXJuIHJlc3VsdDtcbn1cblxuLyogV29ya2luZyB3aXRoIGNvb2tpZSBhcnJheSAqL1xuXG5sZXQgYXJ0aWNsZUNvb2tpZXMgPSBbXTtcblxuaWYgKHBvc3RCb29rbWFyaykge1xuICBwb3N0Qm9va21hcmsuYWRkRXZlbnRMaXN0ZW5lcihgY2xpY2tgLCAoZXZ0KT0+e1xuICAgIGV2dC5wcmV2ZW50RGVmYXVsdCgpO1xuXG4gICAgbGV0IGFydGljbGVJZCA9IGFydGljbGUuZ2V0QXR0cmlidXRlKGBkYXRhLWlkYCk7XG4gICAgbGV0IHBvc3RCb29rbWFya0ljb24gPSBwb3N0Qm9va21hcmsucXVlcnlTZWxlY3RvcihgaW1nYCk7XG5cbiAgICBpZiAocG9zdEJvb2ttYXJrSWNvbi5nZXRBdHRyaWJ1dGUoYHNyY2ApID09PSBgaW1nL2ljb25zL2ljb24tYm9va21hcmsuc3ZnYCkge1xuICAgICAgcG9zdEJvb2ttYXJrSWNvbi5zZXRBdHRyaWJ1dGUoYHNyY2AsIGBpbWcvaWNvbnMvaWNvbi1ib29rbWFyay1maWxsLnN2Z2ApO1xuICAgIH0gZWxzZSB7XG4gICAgICBwb3N0Qm9va21hcmtJY29uLnNldEF0dHJpYnV0ZShgc3JjYCwgYGltZy9pY29ucy9pY29uLWJvb2ttYXJrLnN2Z2ApO1xuICAgIH1cblxuICAgIGxldCBuZXdDb29raWUgPSBbYGRhdGFJZGAsIGFydGljbGVJZF07XG4gICAgbGV0IGFydGljbGVzTGlzdCA9IEpTT04ucGFyc2UoZ2V0Q29va2llKCdhcnRpY2xlc0xpc3QnKSkgfHwgW107XG5cbiAgICBjb25zdCBmaWx0ZXJSZXN1bHQgPSBjaGVja0Nvb2tpZUluQXJyYXkoYXJ0aWNsZXNMaXN0LCBuZXdDb29raWUpO1xuICAgIGNvbnNvbGUubG9nKGZpbHRlclJlc3VsdClcblxuICAgIGlmIChmaWx0ZXJSZXN1bHQpIHtcbiAgICAgIGNvbnNvbGUubG9nKGByZW1vdmluZyBmcm9tIGFycmF5Li4uYCk7XG4gICAgICBjb25zdCBmaWx0ZXJlZEFycmF5ID0gYXJ0aWNsZXNMaXN0LmZpbHRlcigoaXRlbSkgPT4ge1xuICAgICAgICBpZiAoaXRlbVsxXSAhPT0gbmV3Q29va2llWzFdKSB7XG4gICAgICAgICAgcmV0dXJuIGl0ZW07XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgICAgZGVsZXRlQ29va2llKGBhcnRpY2xlc0xpc3RgKTtcbiAgICAgIGNvbnNvbGUubG9nKGBGaWx0ZXJlZCBhcnJheS4uLmAsIGZpbHRlcmVkQXJyYXkpO1xuICAgICAgc2V0Q29va2llKCdhcnRpY2xlc0xpc3QnLCBKU09OLnN0cmluZ2lmeShmaWx0ZXJlZEFycmF5KSwgeydtYXgtYWdlJzogMzYwMCwgZXhwaXJlczogYFR1ZSwgMTkgSmFuIDIwMzggMDM6MTQ6MDcgR01UYH0pO1xuICAgIH0gZWxzZSB7XG4gICAgICBjb25zb2xlLmxvZyhgQWRkIHRvIGFycmF5Li4uYCk7XG4gICAgICBhcnRpY2xlc0xpc3QgPSBhcnRpY2xlc0xpc3QuY29uY2F0KFtuZXdDb29raWVdKTtcbiAgICAgIGNvbnNvbGUubG9nKGBBcnJheSB3aXRoIG5ldyBpZC4uLmAsIGFydGljbGVzTGlzdCk7XG4gICAgICBzZXRDb29raWUoJ2FydGljbGVzTGlzdCcsIEpTT04uc3RyaW5naWZ5KGFydGljbGVzTGlzdCksIHsnbWF4LWFnZSc6IDM2MDAsIGV4cGlyZXM6IGBUdWUsIDE5IEphbiAyMDM4IDAzOjE0OjA3IEdNVGB9KTtcbiAgICB9XG4gIH0pO1xufVxuXG5pZiAocG9zdEJvb2ttYXJrTW9iKSB7XG4gIHBvc3RCb29rbWFya01vYi5hZGRFdmVudExpc3RlbmVyKGBjbGlja2AsIChldnQpPT57XG4gICAgZXZ0LnByZXZlbnREZWZhdWx0KCk7XG5cbiAgICBsZXQgYXJ0aWNsZUlkID0gYXJ0aWNsZS5nZXRBdHRyaWJ1dGUoYGRhdGEtaWRgKTtcbiAgICBsZXQgYXJ0aWNsZUNvb2tpZU5hbWUgPSBgZGF0YS1pZGA7XG4gICAgbGV0IHBvc3RCb29rbWFya0ljb24gPSBwb3N0Qm9va21hcmtNb2IucXVlcnlTZWxlY3RvcihgaW1nYCk7XG5cbiAgICBpZiAocG9zdEJvb2ttYXJrSWNvbi5nZXRBdHRyaWJ1dGUoYHNyY2ApID09PSBgaW1nL2ljb25zL2ljb24tYm9va21hcmsuc3ZnYCkge1xuICAgICAgcG9zdEJvb2ttYXJrSWNvbi5zZXRBdHRyaWJ1dGUoYHNyY2AsIGBpbWcvaWNvbnMvaWNvbi1ib29rbWFyay1maWxsLnN2Z2ApO1xuICAgIH0gZWxzZSB7XG4gICAgICBwb3N0Qm9va21hcmtJY29uLnNldEF0dHJpYnV0ZShgc3JjYCwgYGltZy9pY29ucy9pY29uLWJvb2ttYXJrLnN2Z2ApO1xuICAgIH1cblxuICAgIGxldCBjb29raWVEYXRlID0gbmV3IERhdGUoKTtcbiAgICBjb29raWVEYXRlLnNldFRpbWUoY29va2llRGF0ZS5nZXRUaW1lKCkgKyAoMTQ0MCAqIDYwICogMTAwMCkpO1xuICAgIGxldCBkYXRlID0gY29va2llRGF0ZS50b1VUQ1N0cmluZygpO1xuXG4gICAgZG9jdW1lbnQuY29va2llID0gZW5jb2RlVVJJQ29tcG9uZW50KGFydGljbGVDb29raWVOYW1lKSArIGA9YCArIGVuY29kZVVSSUNvbXBvbmVudChhcnRpY2xlSWQpICsgYGV4cGlyZXM9YCArIGRhdGU7XG4gIH0pO1xufVxuIl0sImZpbGUiOiJtYWluLmpzIn0=
