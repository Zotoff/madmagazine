"use strict";
jQuery(function () {

  /* Handle comments like buttons */

  const mobileNav = $(`#headerMobileNav`);
  const mobileMenu = $(`#headerMobileMenu`);
  const mobileClose = $(`#headerMobileClose`);
  const mobileSubscribe = $(`#headerMobileSubscribe`);
  const footerSubscribeForm = $(`#footerSubscribe`);
  const headerSubscribeButton = $(`#headerSubscribeButton`);
  const postCommentsLink = $(`#postCommentsLink`);
  const postCommentsBlock = $(`#postComments`);

  const checkCommentLike = (item) => {
    const commentLikeButton = item.find(`.comments__like__btn--like`);
    const commentDisLikeButton = item.find(`.comments__like__btn--dislike`);
    const commentCount = item.find(`.comments__views`);
    let commentCountValue = +commentCount.attr(`data-count`);


    commentLikeButton.on(`click`, (evt) => {
      evt.preventDefault();
      commentDisLikeButton.removeClass(`comments__like__btn--active`);
      commentLikeButton.addClass(`comments__like__btn--active`);
      commentCountValue += 1;
      commentCount.text(`+${commentCountValue}`);
      commentCount.attr(`data-count`, commentCountValue);

      let commentId = item.attr(`data-commentid`);
      let commentURL = item.attr(`data-commentURL`);

      $.ajax({
        method: `GET`,
        url: commentURL,
        data: {
          commentId,
          commentCount: commentCountValue
        },
        success(response) {
          console.log(response);
        },
        error(response) {
          console.log(response);
        }
      });
    });
    commentDisLikeButton.on(`click`, (evt) => {
      evt.preventDefault();
      commentDisLikeButton.addClass(`comments__like__btn--active`);
      commentLikeButton.removeClass(`comments__like__btn--active`);
      commentCountValue -= 1;
      commentCount.text(`+${commentCountValue}`);
      commentCount.attr(`data-count`, commentCountValue);

      let commentId = item.attr(`data-commentid`);
      let commentURL = item.attr(`data-commentURL`);

      $.ajax({
        method: `GET`,
        url: commentURL,
        data: {
          commentId,
          commentCount: commentCountValue
        },
        success(response) {
          console.log(response);
        },
        error(response) {
          console.log(response);
        }
      });
    });
  };

  const commentBlocks = $(`.comments__block:not(.comments__block__form)`);
  commentBlocks.each(function () {
    const commentItems = $(this).find(`.comments__item`);
    commentItems.each(function () {
      checkCommentLike($(this));
      $(this).attr(`data-commentid`, `comment-${generateRandomId(8)}`);
      $(this).attr(`data-commenturl`, `./ajax/response.json`);
    });
  });

  mobileNav.on(`click`, (evt) => {
    evt.preventDefault();
    mobileMenu.addClass(`show`);
  });
  mobileClose.on(`click`, (evt) => {
    evt.preventDefault();
    mobileMenu.removeClass(`show`);
  });
  headerSubscribeButton.on(`click`, (evt) => {
    evt.preventDefault();
    footerSubscribeForm[0].scrollIntoView({block: `start`, behavior: `smooth`});
  });

  if (mobileSubscribe) {
    mobileSubscribe.on(`click`, (evt) => {
      evt.preventDefault();
      footerSubscribeForm[0].scrollIntoView({block: `start`, behavior: `smooth`});
      mobileMenu.removeClass(`show`);
    });
  }

  postCommentsLink.on(`click`, (evt) => {
    evt.preventDefault();
    $('html,body').animate({scrollTop: $(`.comments__filter`).offset().top - $('#mainHeader').outerHeight() + 15}, 500);
  });

  const scrollToSection = (dataLink) => {
    const sectionsWithData = $(`section.short-section`);
    sectionsWithData.each(function () {
      const sectionWithData = $(this);
      if (dataLink === sectionWithData.attr(`data-id`)) {
        $('html,body').animate({scrollTop: $(this).offset().top - $('#mainHeader').outerHeight() + 15}, 500);
      }
    });
  };

  const categoryNavList = $(`#categoryNavList li a`);
  categoryNavList.each(function (item) {
    const navLink = $(this);
    navLink.on(`click`, (evt) => {
      evt.preventDefault();
      const navLinkDataLink = $(this).attr(`data-link`);
      scrollToSection(navLinkDataLink);
    });
  });

  /* Comments form */

  const commentsForm = $(`#commentsForm`);

  if (commentsForm) {
    const commentsUrl =  commentsForm.attr(`action`);
    if (commentsForm[0]) {
      commentsForm[0].reset();
    }

    commentsForm.validate({
      submitHandler(form) {
        let comment = $(`textarea`).val();
        $.ajax({
            type: "GET",
            url: commentsUrl,
            data: {name: `Author`, message: comment}
          }).done(function( msg ) {
            console.log(msg);
            form.reset();
            let commentMessage = $(`#commentMessage`);
            commentMessage.text(`Ваш комментарий успешно отправлен`);
            commentMessage.attr(`data-success`, true);
          }).fail(function() {
            let commentMessage = $(`#commentMessage`);
            commentMessage.text(`При отправке вашего запроса возникла ошибка`)
            console.log(`Something wrong`);
            commentMessage.attr(`data-success`, false);
          })
      }
    });
  }

  /* Subscribe form */

  const subscribeForm = $(`#subscribeForm`);

  if (subscribeForm) {
    const subscribeUrl = subscribeForm.attr(`action`);
    if (subscribeForm[0]) {
      subscribeForm[0].reset();
    }

    subscribeForm.validate({
      submitHandler(form) {
        let email = $(`#subscribeEmail`).val();
        $.ajax({
            type: "GET",
            url: subscribeUrl,
            data: {name: `Author`, email: email}
          }).done(function( msg ) {
            console.log(msg);
            form.reset();
            let subscribeMessage = $(`#subscribeMessage`);
            subscribeMessage.text(`Вы успешно подписались на рассылку!`);
            subscribeMessage.attr(`data-success`, true);
          }).fail(function() {
            let subscribeMessage = $(`#subscribeMessage`);
            subscribeMessage.text(`При отправке вашего запроса возникла ошибка`)
            console.log(`Something wrong`);
            subscribeMessage.attr(`data-success`, false);
          })
      }
    });
  }

  /* Illustration handle */
  const articleIllustrations = $(`.article__illustration`);
  articleIllustrations.each(function() {
    const illustration = $(this);
    const img = $(this).find(`img`);
    const figCaption = $(this).find(`figcaption`);
    const imgWidth = $(this).data(`width`);
    const imgHeight = $(this).data(`height`);
    const imgAlign = $(this).data(`align`);
    img.attr(`width`, imgWidth);
    img.attr(`height`, imgHeight);
    switch(imgAlign) {
      case `center`:
        illustration.css(`justify-content`, `center`);
        figCaption.css(`text-align`, `center`);
        break;
      case `left`:
        illustration.css(`justify-content`, `flex-start`);
        figCaption.css(`text-align`, `left`);
        break;
      default:
        illustration.css(`justify-content`, `flex-end`);
        figCaption.css(`text-align`, `right`);
    }
  });

  /* Buttons */
  const goButtons = $(`.btn__go`);
  goButtons.each(function(){
    const goButton = $(this);
    const goButtonColor = $(this).data(`color`);
    const goButtonBackground = $(this).data(`background`);
    const goButtonRadius = $(this).data(`radius`);
    const goButtonAlign = $(this).data(`align`);
    const goButtonHref = $(this).data(`href`);
    const goButtonTarget = $(this).data(`target`);

    goButton.css(`color`, goButtonColor);
    goButton.css(`background-color`, goButtonBackground);
    goButton.css(`border-radius`, `${goButtonRadius}px`);
    goButton.attr(`href`, goButtonHref);
    goButton.attr(`target`, goButtonTarget);

    switch(goButtonAlign) {
      case `left`:
        goButton.css({'margin-left': '0', 'margin-right': 'auto'});
        break;
      case `right`:
        goButton.css({'margin-left': 'auto', 'margin-right': '0'});
        break;
      default:
        goButton.css({'margin-left': 'auto', 'margin-right': 'auto'});
    }
  })

});

/* Initiate sliders */
const articleCarousel = document.querySelector(`#articleCarousel`);
if (articleCarousel) {
  const slider = tns({
    container: `#articleCarousel`,
    slideBy: `page`,
    items: 1,
    controlsContainer: `#articleSliderControls`,
    navContainer: `#articleSliderNav`,
    loop: false,
  });
}

const desktopPromoSlider = document.querySelector(`#desktopPromoSlider`);
if (desktopPromoSlider) {
  const desktopPromoSlider = tns({
    container: `#desktopPromoSlider`,
    slideBy: `page`,
    items: 1,
    controls: false,
    nav: false,
  });
}

const mobilePromoSlider = document.querySelector(`#mobilePromoSlider`);
if (mobilePromoSlider) {
  const mobilePromoSlider = tns({
    container: `#mobilePromoSlider`,
    slideBy: `page`,
    items: 1,
    controls: false,
    nav: false,
  });
}

const mainPromoSlider = document.querySelector(`#mainPromoCarousel`);
if (mainPromoSlider) {
  const mainPromoSlider = tns({
    container: `#mainPromoCarousel`,
    slideBy: `page`,
    items: 1,
    controls: false,
    nav: false,
  });
}

/* Generate random ID */

const generateRandomId = (length) => {
  const letters = `0123456789ABCDEFGHIJKLMNOPQRSTUVWXTZabcdefghiklmnopqrstuvwxyz`.split(``);

  if (!length) {
    length = Math.floor(Math.random() * letters.length);
  }

  let str = ``;

  for (let i = 0; i < length; i++) {
    str += letters[Math.floor(Math.random() * letters.length)];
  }
  return str;
};

/* Post bookmark click */

const article = document.querySelector(`.article`);
const postBookmark = document.querySelector(`.post-bookmark`);
const postBookmarkMob = document.querySelector(`.post-bookmark--mob`);

if (article) {
  article.setAttribute(`data-id`, generateRandomId(8));
}

function setCookie(name, value, options = {}) {

  options = {
    path: '/',
    ...options
  };

  if (options.expires instanceof Date) {
    options.expires = options.expires.toUTCString();
  }

  let updatedCookie = encodeURIComponent(name) + "=" + encodeURIComponent(value);

  for (let optionKey in options) {
    updatedCookie += "; " + optionKey;
    let optionValue = options[optionKey];
    if (optionValue !== true) {
      updatedCookie += "=" + optionValue;
    }
  }

  document.cookie = updatedCookie;
}

function getCookie(name) {
  var matches = document.cookie.match(new RegExp(
    "(?:^|; )" + name.replace(/([\.$?*|{}\(\)\[\]\\\/\+^])/g, '\\$1') + "=([^;]*)"
  ));
  return matches ? decodeURIComponent(matches[1]) : '[]';
}

function deleteCookie(name) {
  setCookie(name, "", {
    'max-age': -1
  })
}

/* Working with cookies on bookmarks */

if (postBookmark) {
  postBookmark.addEventListener(`click`, (evt)=>{
    evt.preventDefault();

    let articleId = article.getAttribute(`data-id`);

    let state = 0;

    postBookmark.classList.toggle('post-bookmark--active');
    postBookmark.toggleAttribute(`enabled`);

    if (postBookmark.classList.contains('post-bookmark--active')) {
      state = 1;
    }
    let articlesList = JSON.parse(getCookie('articlesList')) || [];

    if (state && articlesList.indexOf(articleId) == -1) {
      articlesList.push(articleId);
    } else if (!state && articlesList.indexOf(articleId) != -1) {
      articlesList = articlesList.filter(item => item != articleId);
    }
    setCookie('articlesList', JSON.stringify(articlesList), {'max-age': 3600, expires: `Tue, 19 Jan 2038 03:14:07 GMT`});
  });
}

if (postBookmarkMob) {
  postBookmarkMob.addEventListener(`click`, (evt)=>{
    evt.preventDefault();

    let articleId = article.getAttribute(`data-id`);
    let articleCookieName = `data-id`;
    let postBookmarkIcon = postBookmarkMob.querySelector(`img`);

    if (postBookmarkIcon.getAttribute(`src`) === `img/icons/icon-bookmark.svg`) {
      postBookmarkIcon.setAttribute(`src`, `img/icons/icon-bookmark-fill.svg`);
    } else {
      postBookmarkIcon.setAttribute(`src`, `img/icons/icon-bookmark.svg`);
    }

    let cookieDate = new Date();
    cookieDate.setTime(cookieDate.getTime() + (1440 * 60 * 1000));
    let date = cookieDate.toUTCString();

    document.cookie = encodeURIComponent(articleCookieName) + `=` + encodeURIComponent(articleId) + `expires=` + date;
  });
}


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiIiwic291cmNlcyI6WyJtYWluLmpzIl0sInNvdXJjZXNDb250ZW50IjpbIlwidXNlIHN0cmljdFwiO1xualF1ZXJ5KGZ1bmN0aW9uICgpIHtcblxuICAvKiBIYW5kbGUgY29tbWVudHMgbGlrZSBidXR0b25zICovXG5cbiAgY29uc3QgbW9iaWxlTmF2ID0gJChgI2hlYWRlck1vYmlsZU5hdmApO1xuICBjb25zdCBtb2JpbGVNZW51ID0gJChgI2hlYWRlck1vYmlsZU1lbnVgKTtcbiAgY29uc3QgbW9iaWxlQ2xvc2UgPSAkKGAjaGVhZGVyTW9iaWxlQ2xvc2VgKTtcbiAgY29uc3QgbW9iaWxlU3Vic2NyaWJlID0gJChgI2hlYWRlck1vYmlsZVN1YnNjcmliZWApO1xuICBjb25zdCBmb290ZXJTdWJzY3JpYmVGb3JtID0gJChgI2Zvb3RlclN1YnNjcmliZWApO1xuICBjb25zdCBoZWFkZXJTdWJzY3JpYmVCdXR0b24gPSAkKGAjaGVhZGVyU3Vic2NyaWJlQnV0dG9uYCk7XG4gIGNvbnN0IHBvc3RDb21tZW50c0xpbmsgPSAkKGAjcG9zdENvbW1lbnRzTGlua2ApO1xuICBjb25zdCBwb3N0Q29tbWVudHNCbG9jayA9ICQoYCNwb3N0Q29tbWVudHNgKTtcblxuICBjb25zdCBjaGVja0NvbW1lbnRMaWtlID0gKGl0ZW0pID0+IHtcbiAgICBjb25zdCBjb21tZW50TGlrZUJ1dHRvbiA9IGl0ZW0uZmluZChgLmNvbW1lbnRzX19saWtlX19idG4tLWxpa2VgKTtcbiAgICBjb25zdCBjb21tZW50RGlzTGlrZUJ1dHRvbiA9IGl0ZW0uZmluZChgLmNvbW1lbnRzX19saWtlX19idG4tLWRpc2xpa2VgKTtcbiAgICBjb25zdCBjb21tZW50Q291bnQgPSBpdGVtLmZpbmQoYC5jb21tZW50c19fdmlld3NgKTtcbiAgICBsZXQgY29tbWVudENvdW50VmFsdWUgPSArY29tbWVudENvdW50LmF0dHIoYGRhdGEtY291bnRgKTtcblxuXG4gICAgY29tbWVudExpa2VCdXR0b24ub24oYGNsaWNrYCwgKGV2dCkgPT4ge1xuICAgICAgZXZ0LnByZXZlbnREZWZhdWx0KCk7XG4gICAgICBjb21tZW50RGlzTGlrZUJ1dHRvbi5yZW1vdmVDbGFzcyhgY29tbWVudHNfX2xpa2VfX2J0bi0tYWN0aXZlYCk7XG4gICAgICBjb21tZW50TGlrZUJ1dHRvbi5hZGRDbGFzcyhgY29tbWVudHNfX2xpa2VfX2J0bi0tYWN0aXZlYCk7XG4gICAgICBjb21tZW50Q291bnRWYWx1ZSArPSAxO1xuICAgICAgY29tbWVudENvdW50LnRleHQoYCske2NvbW1lbnRDb3VudFZhbHVlfWApO1xuICAgICAgY29tbWVudENvdW50LmF0dHIoYGRhdGEtY291bnRgLCBjb21tZW50Q291bnRWYWx1ZSk7XG5cbiAgICAgIGxldCBjb21tZW50SWQgPSBpdGVtLmF0dHIoYGRhdGEtY29tbWVudGlkYCk7XG4gICAgICBsZXQgY29tbWVudFVSTCA9IGl0ZW0uYXR0cihgZGF0YS1jb21tZW50VVJMYCk7XG5cbiAgICAgICQuYWpheCh7XG4gICAgICAgIG1ldGhvZDogYEdFVGAsXG4gICAgICAgIHVybDogY29tbWVudFVSTCxcbiAgICAgICAgZGF0YToge1xuICAgICAgICAgIGNvbW1lbnRJZCxcbiAgICAgICAgICBjb21tZW50Q291bnQ6IGNvbW1lbnRDb3VudFZhbHVlXG4gICAgICAgIH0sXG4gICAgICAgIHN1Y2Nlc3MocmVzcG9uc2UpIHtcbiAgICAgICAgICBjb25zb2xlLmxvZyhyZXNwb25zZSk7XG4gICAgICAgIH0sXG4gICAgICAgIGVycm9yKHJlc3BvbnNlKSB7XG4gICAgICAgICAgY29uc29sZS5sb2cocmVzcG9uc2UpO1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgICB9KTtcbiAgICBjb21tZW50RGlzTGlrZUJ1dHRvbi5vbihgY2xpY2tgLCAoZXZ0KSA9PiB7XG4gICAgICBldnQucHJldmVudERlZmF1bHQoKTtcbiAgICAgIGNvbW1lbnREaXNMaWtlQnV0dG9uLmFkZENsYXNzKGBjb21tZW50c19fbGlrZV9fYnRuLS1hY3RpdmVgKTtcbiAgICAgIGNvbW1lbnRMaWtlQnV0dG9uLnJlbW92ZUNsYXNzKGBjb21tZW50c19fbGlrZV9fYnRuLS1hY3RpdmVgKTtcbiAgICAgIGNvbW1lbnRDb3VudFZhbHVlIC09IDE7XG4gICAgICBjb21tZW50Q291bnQudGV4dChgKyR7Y29tbWVudENvdW50VmFsdWV9YCk7XG4gICAgICBjb21tZW50Q291bnQuYXR0cihgZGF0YS1jb3VudGAsIGNvbW1lbnRDb3VudFZhbHVlKTtcblxuICAgICAgbGV0IGNvbW1lbnRJZCA9IGl0ZW0uYXR0cihgZGF0YS1jb21tZW50aWRgKTtcbiAgICAgIGxldCBjb21tZW50VVJMID0gaXRlbS5hdHRyKGBkYXRhLWNvbW1lbnRVUkxgKTtcblxuICAgICAgJC5hamF4KHtcbiAgICAgICAgbWV0aG9kOiBgR0VUYCxcbiAgICAgICAgdXJsOiBjb21tZW50VVJMLFxuICAgICAgICBkYXRhOiB7XG4gICAgICAgICAgY29tbWVudElkLFxuICAgICAgICAgIGNvbW1lbnRDb3VudDogY29tbWVudENvdW50VmFsdWVcbiAgICAgICAgfSxcbiAgICAgICAgc3VjY2VzcyhyZXNwb25zZSkge1xuICAgICAgICAgIGNvbnNvbGUubG9nKHJlc3BvbnNlKTtcbiAgICAgICAgfSxcbiAgICAgICAgZXJyb3IocmVzcG9uc2UpIHtcbiAgICAgICAgICBjb25zb2xlLmxvZyhyZXNwb25zZSk7XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgIH0pO1xuICB9O1xuXG4gIGNvbnN0IGNvbW1lbnRCbG9ja3MgPSAkKGAuY29tbWVudHNfX2Jsb2NrOm5vdCguY29tbWVudHNfX2Jsb2NrX19mb3JtKWApO1xuICBjb21tZW50QmxvY2tzLmVhY2goZnVuY3Rpb24gKCkge1xuICAgIGNvbnN0IGNvbW1lbnRJdGVtcyA9ICQodGhpcykuZmluZChgLmNvbW1lbnRzX19pdGVtYCk7XG4gICAgY29tbWVudEl0ZW1zLmVhY2goZnVuY3Rpb24gKCkge1xuICAgICAgY2hlY2tDb21tZW50TGlrZSgkKHRoaXMpKTtcbiAgICAgICQodGhpcykuYXR0cihgZGF0YS1jb21tZW50aWRgLCBgY29tbWVudC0ke2dlbmVyYXRlUmFuZG9tSWQoOCl9YCk7XG4gICAgICAkKHRoaXMpLmF0dHIoYGRhdGEtY29tbWVudHVybGAsIGAuL2FqYXgvcmVzcG9uc2UuanNvbmApO1xuICAgIH0pO1xuICB9KTtcblxuICBtb2JpbGVOYXYub24oYGNsaWNrYCwgKGV2dCkgPT4ge1xuICAgIGV2dC5wcmV2ZW50RGVmYXVsdCgpO1xuICAgIG1vYmlsZU1lbnUuYWRkQ2xhc3MoYHNob3dgKTtcbiAgfSk7XG4gIG1vYmlsZUNsb3NlLm9uKGBjbGlja2AsIChldnQpID0+IHtcbiAgICBldnQucHJldmVudERlZmF1bHQoKTtcbiAgICBtb2JpbGVNZW51LnJlbW92ZUNsYXNzKGBzaG93YCk7XG4gIH0pO1xuICBoZWFkZXJTdWJzY3JpYmVCdXR0b24ub24oYGNsaWNrYCwgKGV2dCkgPT4ge1xuICAgIGV2dC5wcmV2ZW50RGVmYXVsdCgpO1xuICAgIGZvb3RlclN1YnNjcmliZUZvcm1bMF0uc2Nyb2xsSW50b1ZpZXcoe2Jsb2NrOiBgc3RhcnRgLCBiZWhhdmlvcjogYHNtb290aGB9KTtcbiAgfSk7XG5cbiAgaWYgKG1vYmlsZVN1YnNjcmliZSkge1xuICAgIG1vYmlsZVN1YnNjcmliZS5vbihgY2xpY2tgLCAoZXZ0KSA9PiB7XG4gICAgICBldnQucHJldmVudERlZmF1bHQoKTtcbiAgICAgIGZvb3RlclN1YnNjcmliZUZvcm1bMF0uc2Nyb2xsSW50b1ZpZXcoe2Jsb2NrOiBgc3RhcnRgLCBiZWhhdmlvcjogYHNtb290aGB9KTtcbiAgICAgIG1vYmlsZU1lbnUucmVtb3ZlQ2xhc3MoYHNob3dgKTtcbiAgICB9KTtcbiAgfVxuXG4gIHBvc3RDb21tZW50c0xpbmsub24oYGNsaWNrYCwgKGV2dCkgPT4ge1xuICAgIGV2dC5wcmV2ZW50RGVmYXVsdCgpO1xuICAgICQoJ2h0bWwsYm9keScpLmFuaW1hdGUoe3Njcm9sbFRvcDogJChgLmNvbW1lbnRzX19maWx0ZXJgKS5vZmZzZXQoKS50b3AgLSAkKCcjbWFpbkhlYWRlcicpLm91dGVySGVpZ2h0KCkgKyAxNX0sIDUwMCk7XG4gIH0pO1xuXG4gIGNvbnN0IHNjcm9sbFRvU2VjdGlvbiA9IChkYXRhTGluaykgPT4ge1xuICAgIGNvbnN0IHNlY3Rpb25zV2l0aERhdGEgPSAkKGBzZWN0aW9uLnNob3J0LXNlY3Rpb25gKTtcbiAgICBzZWN0aW9uc1dpdGhEYXRhLmVhY2goZnVuY3Rpb24gKCkge1xuICAgICAgY29uc3Qgc2VjdGlvbldpdGhEYXRhID0gJCh0aGlzKTtcbiAgICAgIGlmIChkYXRhTGluayA9PT0gc2VjdGlvbldpdGhEYXRhLmF0dHIoYGRhdGEtaWRgKSkge1xuICAgICAgICAkKCdodG1sLGJvZHknKS5hbmltYXRlKHtzY3JvbGxUb3A6ICQodGhpcykub2Zmc2V0KCkudG9wIC0gJCgnI21haW5IZWFkZXInKS5vdXRlckhlaWdodCgpICsgMTV9LCA1MDApO1xuICAgICAgfVxuICAgIH0pO1xuICB9O1xuXG4gIGNvbnN0IGNhdGVnb3J5TmF2TGlzdCA9ICQoYCNjYXRlZ29yeU5hdkxpc3QgbGkgYWApO1xuICBjYXRlZ29yeU5hdkxpc3QuZWFjaChmdW5jdGlvbiAoaXRlbSkge1xuICAgIGNvbnN0IG5hdkxpbmsgPSAkKHRoaXMpO1xuICAgIG5hdkxpbmsub24oYGNsaWNrYCwgKGV2dCkgPT4ge1xuICAgICAgZXZ0LnByZXZlbnREZWZhdWx0KCk7XG4gICAgICBjb25zdCBuYXZMaW5rRGF0YUxpbmsgPSAkKHRoaXMpLmF0dHIoYGRhdGEtbGlua2ApO1xuICAgICAgc2Nyb2xsVG9TZWN0aW9uKG5hdkxpbmtEYXRhTGluayk7XG4gICAgfSk7XG4gIH0pO1xuXG4gIC8qIENvbW1lbnRzIGZvcm0gKi9cblxuICBjb25zdCBjb21tZW50c0Zvcm0gPSAkKGAjY29tbWVudHNGb3JtYCk7XG5cbiAgaWYgKGNvbW1lbnRzRm9ybSkge1xuICAgIGNvbnN0IGNvbW1lbnRzVXJsID0gIGNvbW1lbnRzRm9ybS5hdHRyKGBhY3Rpb25gKTtcbiAgICBpZiAoY29tbWVudHNGb3JtWzBdKSB7XG4gICAgICBjb21tZW50c0Zvcm1bMF0ucmVzZXQoKTtcbiAgICB9XG5cbiAgICBjb21tZW50c0Zvcm0udmFsaWRhdGUoe1xuICAgICAgc3VibWl0SGFuZGxlcihmb3JtKSB7XG4gICAgICAgIGxldCBjb21tZW50ID0gJChgdGV4dGFyZWFgKS52YWwoKTtcbiAgICAgICAgJC5hamF4KHtcbiAgICAgICAgICAgIHR5cGU6IFwiR0VUXCIsXG4gICAgICAgICAgICB1cmw6IGNvbW1lbnRzVXJsLFxuICAgICAgICAgICAgZGF0YToge25hbWU6IGBBdXRob3JgLCBtZXNzYWdlOiBjb21tZW50fVxuICAgICAgICAgIH0pLmRvbmUoZnVuY3Rpb24oIG1zZyApIHtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKG1zZyk7XG4gICAgICAgICAgICBmb3JtLnJlc2V0KCk7XG4gICAgICAgICAgICBsZXQgY29tbWVudE1lc3NhZ2UgPSAkKGAjY29tbWVudE1lc3NhZ2VgKTtcbiAgICAgICAgICAgIGNvbW1lbnRNZXNzYWdlLnRleHQoYNCS0LDRiCDQutC+0LzQvNC10L3RgtCw0YDQuNC5INGD0YHQv9C10YjQvdC+INC+0YLQv9GA0LDQstC70LXQvWApO1xuICAgICAgICAgICAgY29tbWVudE1lc3NhZ2UuYXR0cihgZGF0YS1zdWNjZXNzYCwgdHJ1ZSk7XG4gICAgICAgICAgfSkuZmFpbChmdW5jdGlvbigpIHtcbiAgICAgICAgICAgIGxldCBjb21tZW50TWVzc2FnZSA9ICQoYCNjb21tZW50TWVzc2FnZWApO1xuICAgICAgICAgICAgY29tbWVudE1lc3NhZ2UudGV4dChg0J/RgNC4INC+0YLQv9GA0LDQstC60LUg0LLQsNGI0LXQs9C+INC30LDQv9GA0L7RgdCwINCy0L7Qt9C90LjQutC70LAg0L7RiNC40LHQutCwYClcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKGBTb21ldGhpbmcgd3JvbmdgKTtcbiAgICAgICAgICAgIGNvbW1lbnRNZXNzYWdlLmF0dHIoYGRhdGEtc3VjY2Vzc2AsIGZhbHNlKTtcbiAgICAgICAgICB9KVxuICAgICAgfVxuICAgIH0pO1xuICB9XG5cbiAgLyogU3Vic2NyaWJlIGZvcm0gKi9cblxuICBjb25zdCBzdWJzY3JpYmVGb3JtID0gJChgI3N1YnNjcmliZUZvcm1gKTtcblxuICBpZiAoc3Vic2NyaWJlRm9ybSkge1xuICAgIGNvbnN0IHN1YnNjcmliZVVybCA9IHN1YnNjcmliZUZvcm0uYXR0cihgYWN0aW9uYCk7XG4gICAgaWYgKHN1YnNjcmliZUZvcm1bMF0pIHtcbiAgICAgIHN1YnNjcmliZUZvcm1bMF0ucmVzZXQoKTtcbiAgICB9XG5cbiAgICBzdWJzY3JpYmVGb3JtLnZhbGlkYXRlKHtcbiAgICAgIHN1Ym1pdEhhbmRsZXIoZm9ybSkge1xuICAgICAgICBsZXQgZW1haWwgPSAkKGAjc3Vic2NyaWJlRW1haWxgKS52YWwoKTtcbiAgICAgICAgJC5hamF4KHtcbiAgICAgICAgICAgIHR5cGU6IFwiR0VUXCIsXG4gICAgICAgICAgICB1cmw6IHN1YnNjcmliZVVybCxcbiAgICAgICAgICAgIGRhdGE6IHtuYW1lOiBgQXV0aG9yYCwgZW1haWw6IGVtYWlsfVxuICAgICAgICAgIH0pLmRvbmUoZnVuY3Rpb24oIG1zZyApIHtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKG1zZyk7XG4gICAgICAgICAgICBmb3JtLnJlc2V0KCk7XG4gICAgICAgICAgICBsZXQgc3Vic2NyaWJlTWVzc2FnZSA9ICQoYCNzdWJzY3JpYmVNZXNzYWdlYCk7XG4gICAgICAgICAgICBzdWJzY3JpYmVNZXNzYWdlLnRleHQoYNCS0Ysg0YPRgdC/0LXRiNC90L4g0L/QvtC00L/QuNGB0LDQu9C40YHRjCDQvdCwINGA0LDRgdGB0YvQu9C60YMhYCk7XG4gICAgICAgICAgICBzdWJzY3JpYmVNZXNzYWdlLmF0dHIoYGRhdGEtc3VjY2Vzc2AsIHRydWUpO1xuICAgICAgICAgIH0pLmZhaWwoZnVuY3Rpb24oKSB7XG4gICAgICAgICAgICBsZXQgc3Vic2NyaWJlTWVzc2FnZSA9ICQoYCNzdWJzY3JpYmVNZXNzYWdlYCk7XG4gICAgICAgICAgICBzdWJzY3JpYmVNZXNzYWdlLnRleHQoYNCf0YDQuCDQvtGC0L/RgNCw0LLQutC1INCy0LDRiNC10LPQviDQt9Cw0L/RgNC+0YHQsCDQstC+0LfQvdC40LrQu9CwINC+0YjQuNCx0LrQsGApXG4gICAgICAgICAgICBjb25zb2xlLmxvZyhgU29tZXRoaW5nIHdyb25nYCk7XG4gICAgICAgICAgICBzdWJzY3JpYmVNZXNzYWdlLmF0dHIoYGRhdGEtc3VjY2Vzc2AsIGZhbHNlKTtcbiAgICAgICAgICB9KVxuICAgICAgfVxuICAgIH0pO1xuICB9XG5cbiAgLyogSWxsdXN0cmF0aW9uIGhhbmRsZSAqL1xuICBjb25zdCBhcnRpY2xlSWxsdXN0cmF0aW9ucyA9ICQoYC5hcnRpY2xlX19pbGx1c3RyYXRpb25gKTtcbiAgYXJ0aWNsZUlsbHVzdHJhdGlvbnMuZWFjaChmdW5jdGlvbigpIHtcbiAgICBjb25zdCBpbGx1c3RyYXRpb24gPSAkKHRoaXMpO1xuICAgIGNvbnN0IGltZyA9ICQodGhpcykuZmluZChgaW1nYCk7XG4gICAgY29uc3QgZmlnQ2FwdGlvbiA9ICQodGhpcykuZmluZChgZmlnY2FwdGlvbmApO1xuICAgIGNvbnN0IGltZ1dpZHRoID0gJCh0aGlzKS5kYXRhKGB3aWR0aGApO1xuICAgIGNvbnN0IGltZ0hlaWdodCA9ICQodGhpcykuZGF0YShgaGVpZ2h0YCk7XG4gICAgY29uc3QgaW1nQWxpZ24gPSAkKHRoaXMpLmRhdGEoYGFsaWduYCk7XG4gICAgaW1nLmF0dHIoYHdpZHRoYCwgaW1nV2lkdGgpO1xuICAgIGltZy5hdHRyKGBoZWlnaHRgLCBpbWdIZWlnaHQpO1xuICAgIHN3aXRjaChpbWdBbGlnbikge1xuICAgICAgY2FzZSBgY2VudGVyYDpcbiAgICAgICAgaWxsdXN0cmF0aW9uLmNzcyhganVzdGlmeS1jb250ZW50YCwgYGNlbnRlcmApO1xuICAgICAgICBmaWdDYXB0aW9uLmNzcyhgdGV4dC1hbGlnbmAsIGBjZW50ZXJgKTtcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlIGBsZWZ0YDpcbiAgICAgICAgaWxsdXN0cmF0aW9uLmNzcyhganVzdGlmeS1jb250ZW50YCwgYGZsZXgtc3RhcnRgKTtcbiAgICAgICAgZmlnQ2FwdGlvbi5jc3MoYHRleHQtYWxpZ25gLCBgbGVmdGApO1xuICAgICAgICBicmVhaztcbiAgICAgIGRlZmF1bHQ6XG4gICAgICAgIGlsbHVzdHJhdGlvbi5jc3MoYGp1c3RpZnktY29udGVudGAsIGBmbGV4LWVuZGApO1xuICAgICAgICBmaWdDYXB0aW9uLmNzcyhgdGV4dC1hbGlnbmAsIGByaWdodGApO1xuICAgIH1cbiAgfSk7XG5cbiAgLyogQnV0dG9ucyAqL1xuICBjb25zdCBnb0J1dHRvbnMgPSAkKGAuYnRuX19nb2ApO1xuICBnb0J1dHRvbnMuZWFjaChmdW5jdGlvbigpe1xuICAgIGNvbnN0IGdvQnV0dG9uID0gJCh0aGlzKTtcbiAgICBjb25zdCBnb0J1dHRvbkNvbG9yID0gJCh0aGlzKS5kYXRhKGBjb2xvcmApO1xuICAgIGNvbnN0IGdvQnV0dG9uQmFja2dyb3VuZCA9ICQodGhpcykuZGF0YShgYmFja2dyb3VuZGApO1xuICAgIGNvbnN0IGdvQnV0dG9uUmFkaXVzID0gJCh0aGlzKS5kYXRhKGByYWRpdXNgKTtcbiAgICBjb25zdCBnb0J1dHRvbkFsaWduID0gJCh0aGlzKS5kYXRhKGBhbGlnbmApO1xuICAgIGNvbnN0IGdvQnV0dG9uSHJlZiA9ICQodGhpcykuZGF0YShgaHJlZmApO1xuICAgIGNvbnN0IGdvQnV0dG9uVGFyZ2V0ID0gJCh0aGlzKS5kYXRhKGB0YXJnZXRgKTtcblxuICAgIGdvQnV0dG9uLmNzcyhgY29sb3JgLCBnb0J1dHRvbkNvbG9yKTtcbiAgICBnb0J1dHRvbi5jc3MoYGJhY2tncm91bmQtY29sb3JgLCBnb0J1dHRvbkJhY2tncm91bmQpO1xuICAgIGdvQnV0dG9uLmNzcyhgYm9yZGVyLXJhZGl1c2AsIGAke2dvQnV0dG9uUmFkaXVzfXB4YCk7XG4gICAgZ29CdXR0b24uYXR0cihgaHJlZmAsIGdvQnV0dG9uSHJlZik7XG4gICAgZ29CdXR0b24uYXR0cihgdGFyZ2V0YCwgZ29CdXR0b25UYXJnZXQpO1xuXG4gICAgc3dpdGNoKGdvQnV0dG9uQWxpZ24pIHtcbiAgICAgIGNhc2UgYGxlZnRgOlxuICAgICAgICBnb0J1dHRvbi5jc3MoeydtYXJnaW4tbGVmdCc6ICcwJywgJ21hcmdpbi1yaWdodCc6ICdhdXRvJ30pO1xuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgYHJpZ2h0YDpcbiAgICAgICAgZ29CdXR0b24uY3NzKHsnbWFyZ2luLWxlZnQnOiAnYXV0bycsICdtYXJnaW4tcmlnaHQnOiAnMCd9KTtcbiAgICAgICAgYnJlYWs7XG4gICAgICBkZWZhdWx0OlxuICAgICAgICBnb0J1dHRvbi5jc3MoeydtYXJnaW4tbGVmdCc6ICdhdXRvJywgJ21hcmdpbi1yaWdodCc6ICdhdXRvJ30pO1xuICAgIH1cbiAgfSlcblxufSk7XG5cbi8qIEluaXRpYXRlIHNsaWRlcnMgKi9cbmNvbnN0IGFydGljbGVDYXJvdXNlbCA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoYCNhcnRpY2xlQ2Fyb3VzZWxgKTtcbmlmIChhcnRpY2xlQ2Fyb3VzZWwpIHtcbiAgY29uc3Qgc2xpZGVyID0gdG5zKHtcbiAgICBjb250YWluZXI6IGAjYXJ0aWNsZUNhcm91c2VsYCxcbiAgICBzbGlkZUJ5OiBgcGFnZWAsXG4gICAgaXRlbXM6IDEsXG4gICAgY29udHJvbHNDb250YWluZXI6IGAjYXJ0aWNsZVNsaWRlckNvbnRyb2xzYCxcbiAgICBuYXZDb250YWluZXI6IGAjYXJ0aWNsZVNsaWRlck5hdmAsXG4gICAgbG9vcDogZmFsc2UsXG4gIH0pO1xufVxuXG5jb25zdCBkZXNrdG9wUHJvbW9TbGlkZXIgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKGAjZGVza3RvcFByb21vU2xpZGVyYCk7XG5pZiAoZGVza3RvcFByb21vU2xpZGVyKSB7XG4gIGNvbnN0IGRlc2t0b3BQcm9tb1NsaWRlciA9IHRucyh7XG4gICAgY29udGFpbmVyOiBgI2Rlc2t0b3BQcm9tb1NsaWRlcmAsXG4gICAgc2xpZGVCeTogYHBhZ2VgLFxuICAgIGl0ZW1zOiAxLFxuICAgIGNvbnRyb2xzOiBmYWxzZSxcbiAgICBuYXY6IGZhbHNlLFxuICB9KTtcbn1cblxuY29uc3QgbW9iaWxlUHJvbW9TbGlkZXIgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKGAjbW9iaWxlUHJvbW9TbGlkZXJgKTtcbmlmIChtb2JpbGVQcm9tb1NsaWRlcikge1xuICBjb25zdCBtb2JpbGVQcm9tb1NsaWRlciA9IHRucyh7XG4gICAgY29udGFpbmVyOiBgI21vYmlsZVByb21vU2xpZGVyYCxcbiAgICBzbGlkZUJ5OiBgcGFnZWAsXG4gICAgaXRlbXM6IDEsXG4gICAgY29udHJvbHM6IGZhbHNlLFxuICAgIG5hdjogZmFsc2UsXG4gIH0pO1xufVxuXG5jb25zdCBtYWluUHJvbW9TbGlkZXIgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKGAjbWFpblByb21vQ2Fyb3VzZWxgKTtcbmlmIChtYWluUHJvbW9TbGlkZXIpIHtcbiAgY29uc3QgbWFpblByb21vU2xpZGVyID0gdG5zKHtcbiAgICBjb250YWluZXI6IGAjbWFpblByb21vQ2Fyb3VzZWxgLFxuICAgIHNsaWRlQnk6IGBwYWdlYCxcbiAgICBpdGVtczogMSxcbiAgICBjb250cm9sczogZmFsc2UsXG4gICAgbmF2OiBmYWxzZSxcbiAgfSk7XG59XG5cbi8qIEdlbmVyYXRlIHJhbmRvbSBJRCAqL1xuXG5jb25zdCBnZW5lcmF0ZVJhbmRvbUlkID0gKGxlbmd0aCkgPT4ge1xuICBjb25zdCBsZXR0ZXJzID0gYDAxMjM0NTY3ODlBQkNERUZHSElKS0xNTk9QUVJTVFVWV1hUWmFiY2RlZmdoaWtsbW5vcHFyc3R1dnd4eXpgLnNwbGl0KGBgKTtcblxuICBpZiAoIWxlbmd0aCkge1xuICAgIGxlbmd0aCA9IE1hdGguZmxvb3IoTWF0aC5yYW5kb20oKSAqIGxldHRlcnMubGVuZ3RoKTtcbiAgfVxuXG4gIGxldCBzdHIgPSBgYDtcblxuICBmb3IgKGxldCBpID0gMDsgaSA8IGxlbmd0aDsgaSsrKSB7XG4gICAgc3RyICs9IGxldHRlcnNbTWF0aC5mbG9vcihNYXRoLnJhbmRvbSgpICogbGV0dGVycy5sZW5ndGgpXTtcbiAgfVxuICByZXR1cm4gc3RyO1xufTtcblxuLyogUG9zdCBib29rbWFyayBjbGljayAqL1xuXG5jb25zdCBhcnRpY2xlID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcihgLmFydGljbGVgKTtcbmNvbnN0IHBvc3RCb29rbWFyayA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoYC5wb3N0LWJvb2ttYXJrYCk7XG5jb25zdCBwb3N0Qm9va21hcmtNb2IgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKGAucG9zdC1ib29rbWFyay0tbW9iYCk7XG5cbmlmIChhcnRpY2xlKSB7XG4gIGFydGljbGUuc2V0QXR0cmlidXRlKGBkYXRhLWlkYCwgZ2VuZXJhdGVSYW5kb21JZCg4KSk7XG59XG5cbmZ1bmN0aW9uIHNldENvb2tpZShuYW1lLCB2YWx1ZSwgb3B0aW9ucyA9IHt9KSB7XG5cbiAgb3B0aW9ucyA9IHtcbiAgICBwYXRoOiAnLycsXG4gICAgLi4ub3B0aW9uc1xuICB9O1xuXG4gIGlmIChvcHRpb25zLmV4cGlyZXMgaW5zdGFuY2VvZiBEYXRlKSB7XG4gICAgb3B0aW9ucy5leHBpcmVzID0gb3B0aW9ucy5leHBpcmVzLnRvVVRDU3RyaW5nKCk7XG4gIH1cblxuICBsZXQgdXBkYXRlZENvb2tpZSA9IGVuY29kZVVSSUNvbXBvbmVudChuYW1lKSArIFwiPVwiICsgZW5jb2RlVVJJQ29tcG9uZW50KHZhbHVlKTtcblxuICBmb3IgKGxldCBvcHRpb25LZXkgaW4gb3B0aW9ucykge1xuICAgIHVwZGF0ZWRDb29raWUgKz0gXCI7IFwiICsgb3B0aW9uS2V5O1xuICAgIGxldCBvcHRpb25WYWx1ZSA9IG9wdGlvbnNbb3B0aW9uS2V5XTtcbiAgICBpZiAob3B0aW9uVmFsdWUgIT09IHRydWUpIHtcbiAgICAgIHVwZGF0ZWRDb29raWUgKz0gXCI9XCIgKyBvcHRpb25WYWx1ZTtcbiAgICB9XG4gIH1cblxuICBkb2N1bWVudC5jb29raWUgPSB1cGRhdGVkQ29va2llO1xufVxuXG5mdW5jdGlvbiBnZXRDb29raWUobmFtZSkge1xuICB2YXIgbWF0Y2hlcyA9IGRvY3VtZW50LmNvb2tpZS5tYXRjaChuZXcgUmVnRXhwKFxuICAgIFwiKD86Xnw7IClcIiArIG5hbWUucmVwbGFjZSgvKFtcXC4kPyp8e31cXChcXClcXFtcXF1cXFxcXFwvXFwrXl0pL2csICdcXFxcJDEnKSArIFwiPShbXjtdKilcIlxuICApKTtcbiAgcmV0dXJuIG1hdGNoZXMgPyBkZWNvZGVVUklDb21wb25lbnQobWF0Y2hlc1sxXSkgOiAnW10nO1xufVxuXG5mdW5jdGlvbiBkZWxldGVDb29raWUobmFtZSkge1xuICBzZXRDb29raWUobmFtZSwgXCJcIiwge1xuICAgICdtYXgtYWdlJzogLTFcbiAgfSlcbn1cblxuLyogV29ya2luZyB3aXRoIGNvb2tpZXMgb24gYm9va21hcmtzICovXG5cbmlmIChwb3N0Qm9va21hcmspIHtcbiAgcG9zdEJvb2ttYXJrLmFkZEV2ZW50TGlzdGVuZXIoYGNsaWNrYCwgKGV2dCk9PntcbiAgICBldnQucHJldmVudERlZmF1bHQoKTtcblxuICAgIGxldCBhcnRpY2xlSWQgPSBhcnRpY2xlLmdldEF0dHJpYnV0ZShgZGF0YS1pZGApO1xuXG4gICAgbGV0IHN0YXRlID0gMDtcblxuICAgIHBvc3RCb29rbWFyay5jbGFzc0xpc3QudG9nZ2xlKCdwb3N0LWJvb2ttYXJrLS1hY3RpdmUnKTtcbiAgICBwb3N0Qm9va21hcmsudG9nZ2xlQXR0cmlidXRlKGBlbmFibGVkYCk7XG5cbiAgICBpZiAocG9zdEJvb2ttYXJrLmNsYXNzTGlzdC5jb250YWlucygncG9zdC1ib29rbWFyay0tYWN0aXZlJykpIHtcbiAgICAgIHN0YXRlID0gMTtcbiAgICB9XG4gICAgbGV0IGFydGljbGVzTGlzdCA9IEpTT04ucGFyc2UoZ2V0Q29va2llKCdhcnRpY2xlc0xpc3QnKSkgfHwgW107XG5cbiAgICBpZiAoc3RhdGUgJiYgYXJ0aWNsZXNMaXN0LmluZGV4T2YoYXJ0aWNsZUlkKSA9PSAtMSkge1xuICAgICAgYXJ0aWNsZXNMaXN0LnB1c2goYXJ0aWNsZUlkKTtcbiAgICB9IGVsc2UgaWYgKCFzdGF0ZSAmJiBhcnRpY2xlc0xpc3QuaW5kZXhPZihhcnRpY2xlSWQpICE9IC0xKSB7XG4gICAgICBhcnRpY2xlc0xpc3QgPSBhcnRpY2xlc0xpc3QuZmlsdGVyKGl0ZW0gPT4gaXRlbSAhPSBhcnRpY2xlSWQpO1xuICAgIH1cbiAgICBzZXRDb29raWUoJ2FydGljbGVzTGlzdCcsIEpTT04uc3RyaW5naWZ5KGFydGljbGVzTGlzdCksIHsnbWF4LWFnZSc6IDM2MDAsIGV4cGlyZXM6IGBUdWUsIDE5IEphbiAyMDM4IDAzOjE0OjA3IEdNVGB9KTtcbiAgfSk7XG59XG5cbmlmIChwb3N0Qm9va21hcmtNb2IpIHtcbiAgcG9zdEJvb2ttYXJrTW9iLmFkZEV2ZW50TGlzdGVuZXIoYGNsaWNrYCwgKGV2dCk9PntcbiAgICBldnQucHJldmVudERlZmF1bHQoKTtcblxuICAgIGxldCBhcnRpY2xlSWQgPSBhcnRpY2xlLmdldEF0dHJpYnV0ZShgZGF0YS1pZGApO1xuICAgIGxldCBhcnRpY2xlQ29va2llTmFtZSA9IGBkYXRhLWlkYDtcbiAgICBsZXQgcG9zdEJvb2ttYXJrSWNvbiA9IHBvc3RCb29rbWFya01vYi5xdWVyeVNlbGVjdG9yKGBpbWdgKTtcblxuICAgIGlmIChwb3N0Qm9va21hcmtJY29uLmdldEF0dHJpYnV0ZShgc3JjYCkgPT09IGBpbWcvaWNvbnMvaWNvbi1ib29rbWFyay5zdmdgKSB7XG4gICAgICBwb3N0Qm9va21hcmtJY29uLnNldEF0dHJpYnV0ZShgc3JjYCwgYGltZy9pY29ucy9pY29uLWJvb2ttYXJrLWZpbGwuc3ZnYCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHBvc3RCb29rbWFya0ljb24uc2V0QXR0cmlidXRlKGBzcmNgLCBgaW1nL2ljb25zL2ljb24tYm9va21hcmsuc3ZnYCk7XG4gICAgfVxuXG4gICAgbGV0IGNvb2tpZURhdGUgPSBuZXcgRGF0ZSgpO1xuICAgIGNvb2tpZURhdGUuc2V0VGltZShjb29raWVEYXRlLmdldFRpbWUoKSArICgxNDQwICogNjAgKiAxMDAwKSk7XG4gICAgbGV0IGRhdGUgPSBjb29raWVEYXRlLnRvVVRDU3RyaW5nKCk7XG5cbiAgICBkb2N1bWVudC5jb29raWUgPSBlbmNvZGVVUklDb21wb25lbnQoYXJ0aWNsZUNvb2tpZU5hbWUpICsgYD1gICsgZW5jb2RlVVJJQ29tcG9uZW50KGFydGljbGVJZCkgKyBgZXhwaXJlcz1gICsgZGF0ZTtcbiAgfSk7XG59XG5cbiJdLCJmaWxlIjoibWFpbi5qcyJ9
