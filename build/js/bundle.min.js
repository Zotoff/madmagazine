"use strict";
jQuery(function () {

  /* Handle scroll */

  $(window).scroll(() => {
    const scrollPosition = $(window).scrollTop();
    const articlePoster = $(`#articlePoster`);
    const header = $(`#mainHeader`);
    const windowWidth = $(window).width();
    if (articlePoster) {
      if (windowWidth >= 768) {
        if (scrollPosition > 350) {
          articlePoster.addClass(`article__poster--smallHeight`);
        } else {
          articlePoster.removeClass(`article__poster--smallHeight`);
        }
      }
      if (windowWidth < 768) {
        if (scrollPosition > 350) {
          articlePoster.addClass(`article__poster--smallHeight`);
        } else {
          articlePoster.removeClass(`article__poster--smallHeight`);
        }
      }
    }
    if (header) {
      if (windowWidth >= 768) {
        if (scrollPosition > 150) {
          header.addClass(`header--smallHeight`);
        } else {
          header.removeClass(`header--smallHeight`);
        }
      }
      if (windowWidth < 768) {
        if (scrollPosition > 150) {
          header.addClass(`header--smallHeight`);
        } else {
          header.removeClass(`header--smallHeight`);
        }
      }
    }
  });

  /* Handle comments like buttons */

  const mobileNav = $(`#headerMobileNav`);
  const mobileMenu = $(`#headerMobileMenu`);
  const mobileClose = $(`#headerMobileClose`);
  const mobileSubscribe = $(`#headerMobileSubscribe`);
  const footerSubscribeForm = $(`#footerSubscribe`);
  const headerSubscribeButton = $(`#headerSubscribeButton`);
  const postCommentsLink = $(`#postCommentsLink`);
  const postCommentsBlock = $(`#postComments`);

  const checkCommentLike = (item) => {
    const commentLikeButton = item.find(`.comments__like__btn--like`);
    const commentDisLikeButton = item.find(`.comments__like__btn--dislike`);
    const commentCount = item.find(`.comments__views`);
    let commentCountValue = +commentCount.attr(`data-count`);


    commentLikeButton.on(`click`, (evt) => {
      evt.preventDefault();
      commentDisLikeButton.removeClass(`comments__like__btn--active`);
      commentLikeButton.addClass(`comments__like__btn--active`);
      commentCountValue += 1;
      commentCount.text(`+${commentCountValue}`);
      commentCount.attr(`data-count`, commentCountValue);

      let commentId = item.attr(`data-commentid`);
      let commentURL = item.attr(`data-commentURL`);

      $.ajax({
        method: `GET`,
        url: commentURL,
        data: {
          commentId,
          commentCount: commentCountValue
        },
        success(response) {
          console.log(response);
        },
        error(response) {
          console.log(response);
        }
      });
    });
    commentDisLikeButton.on(`click`, (evt) => {
      evt.preventDefault();
      commentDisLikeButton.addClass(`comments__like__btn--active`);
      commentLikeButton.removeClass(`comments__like__btn--active`);
      commentCountValue -= 1;
      commentCount.text(`+${commentCountValue}`);
      commentCount.attr(`data-count`, commentCountValue);

      let commentId = item.attr(`data-commentid`);
      let commentURL = item.attr(`data-commentURL`);

      $.ajax({
        method: `GET`,
        url: commentURL,
        data: {
          commentId,
          commentCount: commentCountValue
        },
        success(response) {
          console.log(response);
        },
        error(response) {
          console.log(response);
        }
      });
    });
  };

  const commentBlocks = $(`.comments__block:not(.comments__block__form)`);
  commentBlocks.each(function () {
    const commentItems = $(this).find(`.comments__item`);
    commentItems.each(function () {
      checkCommentLike($(this));
      $(this).attr(`data-commentid`, `comment-${generateRandomId(8)}`);
      $(this).attr(`data-commenturl`, `http://localhost:3000/ajax/response.json`);
    });
  });

  mobileNav.on(`click`, (evt) => {
    evt.preventDefault();
    mobileMenu.addClass(`show`);
  });
  mobileClose.on(`click`, (evt) => {
    evt.preventDefault();
    mobileMenu.removeClass(`show`);
  });
  headerSubscribeButton.on(`click`, (evt) => {
    evt.preventDefault();
    footerSubscribeForm[0].scrollIntoView({block: `center`, behavior: `smooth`});
  });

  if (mobileSubscribe) {
    mobileSubscribe.on(`click`, (evt) => {
      evt.preventDefault();
      footerSubscribeForm[0].scrollIntoView({block: `center`, behavior: `smooth`});
      mobileMenu.removeClass(`show`);
    });
  }

  postCommentsLink.on(`click`, (evt) => {
    evt.preventDefault();
    postCommentsBlock[0].scrollIntoView({block: `center`, behavior: `smooth`});
  });

  const scrollToSection = (dataLink) => {
    const sectionsWithData = $(`section.short-section`);
    sectionsWithData.each(function () {
      const sectionWithData = $(this);
      if (dataLink === sectionWithData.attr(`data-id`)) {
        sectionWithData[0].scrollIntoView({block: `center`, behavior: `smooth`});
      }
    });
  };

  const categoryNavList = $(`#categoryNavList li a`);
  categoryNavList.each(function (item) {
    const navLink = $(this);
    navLink.on(`click`, (evt) => {
      evt.preventDefault();
      const navLinkDataLink = $(this).attr(`data-link`);
      scrollToSection(navLinkDataLink);
    });
  });

  const commentsForm = $(`#commentsForm`);
  commentsForm[0].reset();

  commentsForm.validate({
    rules: {
      comment: {
        required: true,
        minlength: 2
      }
    },
    messages: {
      comment: {
        required: `Заполните поле!`,
        minlength: `Допустимо минимум два символа при вводе имени`
      }
    },
    submitHandler(form) {
      form.submit();
    }
  });


  /* Handle article Slider */
  const sliderPrevInactiveArrow = $(`.article__slider__prev[aria-disabled=true]`);
  const sliderPrevArrow = $(`.article__slider__prev`);
  const sliderNextArrow = $(`.article__slider__next`);
  const sliderFirstNav = $(`.article__slider__nav`).find(`div:nth-child(1)`);
  const sliderLastNav = $(`.article__slider__nav`).find(`div:last-child`);
  if (sliderPrevInactiveArrow) {
    const sliderArrowIcon = sliderPrevInactiveArrow.find(`img`);
    sliderArrowIcon.attr(`src`, `img/icons/article-slider-prevarrow--inactive.svg`);
  }
  sliderNextArrow.on(`click`, () => {
    const sliderArrowIcon = sliderPrevInactiveArrow.find(`img`);
    sliderArrowIcon.attr(`src`, `img/icons/article-slider-prevarrow.svg`);
  });

  sliderPrevArrow.on(`click`, () => {
    if (sliderFirstNav.hasClass(`tns-nav-active`)) {
      const sliderArrowIcon = sliderPrevArrow.find(`img`);
      sliderArrowIcon.attr(`src`, `img/icons/article-slider-prevarrow--inactive.svg`);
    }
    if (!sliderLastNav.hasClass(`tns-nav-active`)) {
      const sliderArrowIcon = sliderNextArrow.find(`img`);
      sliderArrowIcon.attr(`src`, `img/icons/article-slider-nextarrow.svg`);
    }
  });

  sliderNextArrow.on(`click`, () => {
    if (sliderLastNav.hasClass(`tns-nav-active`)) {
      const sliderArrowIcon = sliderNextArrow.find(`img`);
      sliderArrowIcon.attr(`src`, `img/icons/article-slider-nextarrow--inactive.svg`);
    }
  });

});

/* Initiate sliders */
const articleCarousel = document.querySelector(`#articleCarousel`);
if (articleCarousel) {
  const slider = tns({
    container: `#articleCarousel`,
    slideBy: `page`,
    items: 1,
    controlsContainer: `#articleSliderControls`,
    navContainer: `#articleSliderNav`,
    loop: false,
  });
}

const desktopPromoSlider = document.querySelector(`#desktopPromoSlider`);
if (desktopPromoSlider) {
  const desktopPromoSlider = tns({
    container: `#desktopPromoSlider`,
    slideBy: `page`,
    items: 1,
    controls: false,
    nav: false,
  });
}

const mobilePromoSlider = document.querySelector(`#mobilePromoSlider`);
if (mobilePromoSlider) {
  const mobilePromoSlider = tns({
    container: `#mobilePromoSlider`,
    slideBy: `page`,
    items: 1,
    controls: false,
    nav: false,
  });
}

const mainPromoSlider = document.querySelector(`#mainPromoCarousel`);
if (mainPromoSlider) {
  const mainPromoSlider = tns({
    container: `#mainPromoCarousel`,
    slideBy: `page`,
    items: 1,
    controls: false,
    nav: false,
  });
}

/* Generate random ID */

const generateRandomId = (length) => {
  const letters = `0123456789ABCDEFGHIJKLMNOPQRSTUVWXTZabcdefghiklmnopqrstuvwxyz`.split(``);

  if (!length) {
    length = Math.floor(Math.random() * letters.length);
  }

  let str = ``;

  for (let i = 0; i < length; i++) {
    str += letters[Math.floor(Math.random() * letters.length)];
  }
  return str;
};

/* Post bookmark click */
const article = document.querySelector(`.article`);
const postBookmark = document.querySelector(`.post-bookmark`);
const postBookmarkMob = document.querySelector(`.post-bookmark--mob`);

if (article) {
  article.setAttribute(`data-id`, generateRandomId(8));
}

if (postBookmark) {
  postBookmark.addEventListener(`click`, (evt)=>{
    evt.preventDefault();

    let articleId = article.getAttribute(`data-id`);
    let articleCookieName = `data-id`;
    let postBookmarkIcon = postBookmark.querySelector(`img`);

    if (postBookmarkIcon.getAttribute(`src`) === `img/icons/icon-bookmark.svg`) {
      postBookmarkIcon.setAttribute(`src`, `img/icons/icon-bookmark-fill.svg`);
    } else {
      postBookmarkIcon.setAttribute(`src`, `img/icons/icon-bookmark.svg`);
    }

    let cookieDate = new Date();
    cookieDate.setTime(cookieDate.getTime() + (1440 * 60 * 1000));
    let date = cookieDate.toUTCString();

    document.cookie = encodeURIComponent(articleCookieName) + `=` + encodeURIComponent(articleId) + `expires=` + date;
  });
}

if (postBookmarkMob) {
  postBookmarkMob.addEventListener(`click`, (evt)=>{
    evt.preventDefault();

    let articleId = article.getAttribute(`data-id`);
    let articleCookieName = `data-id`;
    let postBookmarkIcon = postBookmarkMob.querySelector(`img`);

    if (postBookmarkIcon.getAttribute(`src`) === `img/icons/icon-bookmark.svg`) {
      postBookmarkIcon.setAttribute(`src`, `img/icons/icon-bookmark-fill.svg`);
    } else {
      postBookmarkIcon.setAttribute(`src`, `img/icons/icon-bookmark.svg`);
    }

    let cookieDate = new Date();
    cookieDate.setTime(cookieDate.getTime() + (1440 * 60 * 1000));
    let date = cookieDate.toUTCString();

    document.cookie = encodeURIComponent(articleCookieName) + `=` + encodeURIComponent(articleId) + `expires=` + date;
  });
}

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiIiwic291cmNlcyI6WyJtYWluLmpzIl0sInNvdXJjZXNDb250ZW50IjpbIlwidXNlIHN0cmljdFwiO1xualF1ZXJ5KGZ1bmN0aW9uICgpIHtcblxuICAvKiBIYW5kbGUgc2Nyb2xsICovXG5cbiAgJCh3aW5kb3cpLnNjcm9sbCgoKSA9PiB7XG4gICAgY29uc3Qgc2Nyb2xsUG9zaXRpb24gPSAkKHdpbmRvdykuc2Nyb2xsVG9wKCk7XG4gICAgY29uc3QgYXJ0aWNsZVBvc3RlciA9ICQoYCNhcnRpY2xlUG9zdGVyYCk7XG4gICAgY29uc3QgaGVhZGVyID0gJChgI21haW5IZWFkZXJgKTtcbiAgICBjb25zdCB3aW5kb3dXaWR0aCA9ICQod2luZG93KS53aWR0aCgpO1xuICAgIGlmIChhcnRpY2xlUG9zdGVyKSB7XG4gICAgICBpZiAod2luZG93V2lkdGggPj0gNzY4KSB7XG4gICAgICAgIGlmIChzY3JvbGxQb3NpdGlvbiA+IDM1MCkge1xuICAgICAgICAgIGFydGljbGVQb3N0ZXIuYWRkQ2xhc3MoYGFydGljbGVfX3Bvc3Rlci0tc21hbGxIZWlnaHRgKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBhcnRpY2xlUG9zdGVyLnJlbW92ZUNsYXNzKGBhcnRpY2xlX19wb3N0ZXItLXNtYWxsSGVpZ2h0YCk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIGlmICh3aW5kb3dXaWR0aCA8IDc2OCkge1xuICAgICAgICBpZiAoc2Nyb2xsUG9zaXRpb24gPiAzNTApIHtcbiAgICAgICAgICBhcnRpY2xlUG9zdGVyLmFkZENsYXNzKGBhcnRpY2xlX19wb3N0ZXItLXNtYWxsSGVpZ2h0YCk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgYXJ0aWNsZVBvc3Rlci5yZW1vdmVDbGFzcyhgYXJ0aWNsZV9fcG9zdGVyLS1zbWFsbEhlaWdodGApO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICAgIGlmIChoZWFkZXIpIHtcbiAgICAgIGlmICh3aW5kb3dXaWR0aCA+PSA3NjgpIHtcbiAgICAgICAgaWYgKHNjcm9sbFBvc2l0aW9uID4gMTUwKSB7XG4gICAgICAgICAgaGVhZGVyLmFkZENsYXNzKGBoZWFkZXItLXNtYWxsSGVpZ2h0YCk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgaGVhZGVyLnJlbW92ZUNsYXNzKGBoZWFkZXItLXNtYWxsSGVpZ2h0YCk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIGlmICh3aW5kb3dXaWR0aCA8IDc2OCkge1xuICAgICAgICBpZiAoc2Nyb2xsUG9zaXRpb24gPiAxNTApIHtcbiAgICAgICAgICBoZWFkZXIuYWRkQ2xhc3MoYGhlYWRlci0tc21hbGxIZWlnaHRgKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBoZWFkZXIucmVtb3ZlQ2xhc3MoYGhlYWRlci0tc21hbGxIZWlnaHRgKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgfSk7XG5cbiAgLyogSGFuZGxlIGNvbW1lbnRzIGxpa2UgYnV0dG9ucyAqL1xuXG4gIGNvbnN0IG1vYmlsZU5hdiA9ICQoYCNoZWFkZXJNb2JpbGVOYXZgKTtcbiAgY29uc3QgbW9iaWxlTWVudSA9ICQoYCNoZWFkZXJNb2JpbGVNZW51YCk7XG4gIGNvbnN0IG1vYmlsZUNsb3NlID0gJChgI2hlYWRlck1vYmlsZUNsb3NlYCk7XG4gIGNvbnN0IG1vYmlsZVN1YnNjcmliZSA9ICQoYCNoZWFkZXJNb2JpbGVTdWJzY3JpYmVgKTtcbiAgY29uc3QgZm9vdGVyU3Vic2NyaWJlRm9ybSA9ICQoYCNmb290ZXJTdWJzY3JpYmVgKTtcbiAgY29uc3QgaGVhZGVyU3Vic2NyaWJlQnV0dG9uID0gJChgI2hlYWRlclN1YnNjcmliZUJ1dHRvbmApO1xuICBjb25zdCBwb3N0Q29tbWVudHNMaW5rID0gJChgI3Bvc3RDb21tZW50c0xpbmtgKTtcbiAgY29uc3QgcG9zdENvbW1lbnRzQmxvY2sgPSAkKGAjcG9zdENvbW1lbnRzYCk7XG5cbiAgY29uc3QgY2hlY2tDb21tZW50TGlrZSA9IChpdGVtKSA9PiB7XG4gICAgY29uc3QgY29tbWVudExpa2VCdXR0b24gPSBpdGVtLmZpbmQoYC5jb21tZW50c19fbGlrZV9fYnRuLS1saWtlYCk7XG4gICAgY29uc3QgY29tbWVudERpc0xpa2VCdXR0b24gPSBpdGVtLmZpbmQoYC5jb21tZW50c19fbGlrZV9fYnRuLS1kaXNsaWtlYCk7XG4gICAgY29uc3QgY29tbWVudENvdW50ID0gaXRlbS5maW5kKGAuY29tbWVudHNfX3ZpZXdzYCk7XG4gICAgbGV0IGNvbW1lbnRDb3VudFZhbHVlID0gK2NvbW1lbnRDb3VudC5hdHRyKGBkYXRhLWNvdW50YCk7XG5cblxuICAgIGNvbW1lbnRMaWtlQnV0dG9uLm9uKGBjbGlja2AsIChldnQpID0+IHtcbiAgICAgIGV2dC5wcmV2ZW50RGVmYXVsdCgpO1xuICAgICAgY29tbWVudERpc0xpa2VCdXR0b24ucmVtb3ZlQ2xhc3MoYGNvbW1lbnRzX19saWtlX19idG4tLWFjdGl2ZWApO1xuICAgICAgY29tbWVudExpa2VCdXR0b24uYWRkQ2xhc3MoYGNvbW1lbnRzX19saWtlX19idG4tLWFjdGl2ZWApO1xuICAgICAgY29tbWVudENvdW50VmFsdWUgKz0gMTtcbiAgICAgIGNvbW1lbnRDb3VudC50ZXh0KGArJHtjb21tZW50Q291bnRWYWx1ZX1gKTtcbiAgICAgIGNvbW1lbnRDb3VudC5hdHRyKGBkYXRhLWNvdW50YCwgY29tbWVudENvdW50VmFsdWUpO1xuXG4gICAgICBsZXQgY29tbWVudElkID0gaXRlbS5hdHRyKGBkYXRhLWNvbW1lbnRpZGApO1xuICAgICAgbGV0IGNvbW1lbnRVUkwgPSBpdGVtLmF0dHIoYGRhdGEtY29tbWVudFVSTGApO1xuXG4gICAgICAkLmFqYXgoe1xuICAgICAgICBtZXRob2Q6IGBHRVRgLFxuICAgICAgICB1cmw6IGNvbW1lbnRVUkwsXG4gICAgICAgIGRhdGE6IHtcbiAgICAgICAgICBjb21tZW50SWQsXG4gICAgICAgICAgY29tbWVudENvdW50OiBjb21tZW50Q291bnRWYWx1ZVxuICAgICAgICB9LFxuICAgICAgICBzdWNjZXNzKHJlc3BvbnNlKSB7XG4gICAgICAgICAgY29uc29sZS5sb2cocmVzcG9uc2UpO1xuICAgICAgICB9LFxuICAgICAgICBlcnJvcihyZXNwb25zZSkge1xuICAgICAgICAgIGNvbnNvbGUubG9nKHJlc3BvbnNlKTtcbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgfSk7XG4gICAgY29tbWVudERpc0xpa2VCdXR0b24ub24oYGNsaWNrYCwgKGV2dCkgPT4ge1xuICAgICAgZXZ0LnByZXZlbnREZWZhdWx0KCk7XG4gICAgICBjb21tZW50RGlzTGlrZUJ1dHRvbi5hZGRDbGFzcyhgY29tbWVudHNfX2xpa2VfX2J0bi0tYWN0aXZlYCk7XG4gICAgICBjb21tZW50TGlrZUJ1dHRvbi5yZW1vdmVDbGFzcyhgY29tbWVudHNfX2xpa2VfX2J0bi0tYWN0aXZlYCk7XG4gICAgICBjb21tZW50Q291bnRWYWx1ZSAtPSAxO1xuICAgICAgY29tbWVudENvdW50LnRleHQoYCske2NvbW1lbnRDb3VudFZhbHVlfWApO1xuICAgICAgY29tbWVudENvdW50LmF0dHIoYGRhdGEtY291bnRgLCBjb21tZW50Q291bnRWYWx1ZSk7XG5cbiAgICAgIGxldCBjb21tZW50SWQgPSBpdGVtLmF0dHIoYGRhdGEtY29tbWVudGlkYCk7XG4gICAgICBsZXQgY29tbWVudFVSTCA9IGl0ZW0uYXR0cihgZGF0YS1jb21tZW50VVJMYCk7XG5cbiAgICAgICQuYWpheCh7XG4gICAgICAgIG1ldGhvZDogYEdFVGAsXG4gICAgICAgIHVybDogY29tbWVudFVSTCxcbiAgICAgICAgZGF0YToge1xuICAgICAgICAgIGNvbW1lbnRJZCxcbiAgICAgICAgICBjb21tZW50Q291bnQ6IGNvbW1lbnRDb3VudFZhbHVlXG4gICAgICAgIH0sXG4gICAgICAgIHN1Y2Nlc3MocmVzcG9uc2UpIHtcbiAgICAgICAgICBjb25zb2xlLmxvZyhyZXNwb25zZSk7XG4gICAgICAgIH0sXG4gICAgICAgIGVycm9yKHJlc3BvbnNlKSB7XG4gICAgICAgICAgY29uc29sZS5sb2cocmVzcG9uc2UpO1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgICB9KTtcbiAgfTtcblxuICBjb25zdCBjb21tZW50QmxvY2tzID0gJChgLmNvbW1lbnRzX19ibG9jazpub3QoLmNvbW1lbnRzX19ibG9ja19fZm9ybSlgKTtcbiAgY29tbWVudEJsb2Nrcy5lYWNoKGZ1bmN0aW9uICgpIHtcbiAgICBjb25zdCBjb21tZW50SXRlbXMgPSAkKHRoaXMpLmZpbmQoYC5jb21tZW50c19faXRlbWApO1xuICAgIGNvbW1lbnRJdGVtcy5lYWNoKGZ1bmN0aW9uICgpIHtcbiAgICAgIGNoZWNrQ29tbWVudExpa2UoJCh0aGlzKSk7XG4gICAgICAkKHRoaXMpLmF0dHIoYGRhdGEtY29tbWVudGlkYCwgYGNvbW1lbnQtJHtnZW5lcmF0ZVJhbmRvbUlkKDgpfWApO1xuICAgICAgJCh0aGlzKS5hdHRyKGBkYXRhLWNvbW1lbnR1cmxgLCBgaHR0cDovL2xvY2FsaG9zdDozMDAwL2FqYXgvcmVzcG9uc2UuanNvbmApO1xuICAgIH0pO1xuICB9KTtcblxuICBtb2JpbGVOYXYub24oYGNsaWNrYCwgKGV2dCkgPT4ge1xuICAgIGV2dC5wcmV2ZW50RGVmYXVsdCgpO1xuICAgIG1vYmlsZU1lbnUuYWRkQ2xhc3MoYHNob3dgKTtcbiAgfSk7XG4gIG1vYmlsZUNsb3NlLm9uKGBjbGlja2AsIChldnQpID0+IHtcbiAgICBldnQucHJldmVudERlZmF1bHQoKTtcbiAgICBtb2JpbGVNZW51LnJlbW92ZUNsYXNzKGBzaG93YCk7XG4gIH0pO1xuICBoZWFkZXJTdWJzY3JpYmVCdXR0b24ub24oYGNsaWNrYCwgKGV2dCkgPT4ge1xuICAgIGV2dC5wcmV2ZW50RGVmYXVsdCgpO1xuICAgIGZvb3RlclN1YnNjcmliZUZvcm1bMF0uc2Nyb2xsSW50b1ZpZXcoe2Jsb2NrOiBgY2VudGVyYCwgYmVoYXZpb3I6IGBzbW9vdGhgfSk7XG4gIH0pO1xuXG4gIGlmIChtb2JpbGVTdWJzY3JpYmUpIHtcbiAgICBtb2JpbGVTdWJzY3JpYmUub24oYGNsaWNrYCwgKGV2dCkgPT4ge1xuICAgICAgZXZ0LnByZXZlbnREZWZhdWx0KCk7XG4gICAgICBmb290ZXJTdWJzY3JpYmVGb3JtWzBdLnNjcm9sbEludG9WaWV3KHtibG9jazogYGNlbnRlcmAsIGJlaGF2aW9yOiBgc21vb3RoYH0pO1xuICAgICAgbW9iaWxlTWVudS5yZW1vdmVDbGFzcyhgc2hvd2ApO1xuICAgIH0pO1xuICB9XG5cbiAgcG9zdENvbW1lbnRzTGluay5vbihgY2xpY2tgLCAoZXZ0KSA9PiB7XG4gICAgZXZ0LnByZXZlbnREZWZhdWx0KCk7XG4gICAgcG9zdENvbW1lbnRzQmxvY2tbMF0uc2Nyb2xsSW50b1ZpZXcoe2Jsb2NrOiBgY2VudGVyYCwgYmVoYXZpb3I6IGBzbW9vdGhgfSk7XG4gIH0pO1xuXG4gIGNvbnN0IHNjcm9sbFRvU2VjdGlvbiA9IChkYXRhTGluaykgPT4ge1xuICAgIGNvbnN0IHNlY3Rpb25zV2l0aERhdGEgPSAkKGBzZWN0aW9uLnNob3J0LXNlY3Rpb25gKTtcbiAgICBzZWN0aW9uc1dpdGhEYXRhLmVhY2goZnVuY3Rpb24gKCkge1xuICAgICAgY29uc3Qgc2VjdGlvbldpdGhEYXRhID0gJCh0aGlzKTtcbiAgICAgIGlmIChkYXRhTGluayA9PT0gc2VjdGlvbldpdGhEYXRhLmF0dHIoYGRhdGEtaWRgKSkge1xuICAgICAgICBzZWN0aW9uV2l0aERhdGFbMF0uc2Nyb2xsSW50b1ZpZXcoe2Jsb2NrOiBgY2VudGVyYCwgYmVoYXZpb3I6IGBzbW9vdGhgfSk7XG4gICAgICB9XG4gICAgfSk7XG4gIH07XG5cbiAgY29uc3QgY2F0ZWdvcnlOYXZMaXN0ID0gJChgI2NhdGVnb3J5TmF2TGlzdCBsaSBhYCk7XG4gIGNhdGVnb3J5TmF2TGlzdC5lYWNoKGZ1bmN0aW9uIChpdGVtKSB7XG4gICAgY29uc3QgbmF2TGluayA9ICQodGhpcyk7XG4gICAgbmF2TGluay5vbihgY2xpY2tgLCAoZXZ0KSA9PiB7XG4gICAgICBldnQucHJldmVudERlZmF1bHQoKTtcbiAgICAgIGNvbnN0IG5hdkxpbmtEYXRhTGluayA9ICQodGhpcykuYXR0cihgZGF0YS1saW5rYCk7XG4gICAgICBzY3JvbGxUb1NlY3Rpb24obmF2TGlua0RhdGFMaW5rKTtcbiAgICB9KTtcbiAgfSk7XG5cbiAgY29uc3QgY29tbWVudHNGb3JtID0gJChgI2NvbW1lbnRzRm9ybWApO1xuICBjb21tZW50c0Zvcm1bMF0ucmVzZXQoKTtcblxuICBjb21tZW50c0Zvcm0udmFsaWRhdGUoe1xuICAgIHJ1bGVzOiB7XG4gICAgICBjb21tZW50OiB7XG4gICAgICAgIHJlcXVpcmVkOiB0cnVlLFxuICAgICAgICBtaW5sZW5ndGg6IDJcbiAgICAgIH1cbiAgICB9LFxuICAgIG1lc3NhZ2VzOiB7XG4gICAgICBjb21tZW50OiB7XG4gICAgICAgIHJlcXVpcmVkOiBg0JfQsNC/0L7Qu9C90LjRgtC1INC/0L7Qu9C1IWAsXG4gICAgICAgIG1pbmxlbmd0aDogYNCU0L7Qv9GD0YHRgtC40LzQviDQvNC40L3QuNC80YPQvCDQtNCy0LAg0YHQuNC80LLQvtC70LAg0L/RgNC4INCy0LLQvtC00LUg0LjQvNC10L3QuGBcbiAgICAgIH1cbiAgICB9LFxuICAgIHN1Ym1pdEhhbmRsZXIoZm9ybSkge1xuICAgICAgZm9ybS5zdWJtaXQoKTtcbiAgICB9XG4gIH0pO1xuXG5cbiAgLyogSGFuZGxlIGFydGljbGUgU2xpZGVyICovXG4gIGNvbnN0IHNsaWRlclByZXZJbmFjdGl2ZUFycm93ID0gJChgLmFydGljbGVfX3NsaWRlcl9fcHJldlthcmlhLWRpc2FibGVkPXRydWVdYCk7XG4gIGNvbnN0IHNsaWRlclByZXZBcnJvdyA9ICQoYC5hcnRpY2xlX19zbGlkZXJfX3ByZXZgKTtcbiAgY29uc3Qgc2xpZGVyTmV4dEFycm93ID0gJChgLmFydGljbGVfX3NsaWRlcl9fbmV4dGApO1xuICBjb25zdCBzbGlkZXJGaXJzdE5hdiA9ICQoYC5hcnRpY2xlX19zbGlkZXJfX25hdmApLmZpbmQoYGRpdjpudGgtY2hpbGQoMSlgKTtcbiAgY29uc3Qgc2xpZGVyTGFzdE5hdiA9ICQoYC5hcnRpY2xlX19zbGlkZXJfX25hdmApLmZpbmQoYGRpdjpsYXN0LWNoaWxkYCk7XG4gIGlmIChzbGlkZXJQcmV2SW5hY3RpdmVBcnJvdykge1xuICAgIGNvbnN0IHNsaWRlckFycm93SWNvbiA9IHNsaWRlclByZXZJbmFjdGl2ZUFycm93LmZpbmQoYGltZ2ApO1xuICAgIHNsaWRlckFycm93SWNvbi5hdHRyKGBzcmNgLCBgaW1nL2ljb25zL2FydGljbGUtc2xpZGVyLXByZXZhcnJvdy0taW5hY3RpdmUuc3ZnYCk7XG4gIH1cbiAgc2xpZGVyTmV4dEFycm93Lm9uKGBjbGlja2AsICgpID0+IHtcbiAgICBjb25zdCBzbGlkZXJBcnJvd0ljb24gPSBzbGlkZXJQcmV2SW5hY3RpdmVBcnJvdy5maW5kKGBpbWdgKTtcbiAgICBzbGlkZXJBcnJvd0ljb24uYXR0cihgc3JjYCwgYGltZy9pY29ucy9hcnRpY2xlLXNsaWRlci1wcmV2YXJyb3cuc3ZnYCk7XG4gIH0pO1xuXG4gIHNsaWRlclByZXZBcnJvdy5vbihgY2xpY2tgLCAoKSA9PiB7XG4gICAgaWYgKHNsaWRlckZpcnN0TmF2Lmhhc0NsYXNzKGB0bnMtbmF2LWFjdGl2ZWApKSB7XG4gICAgICBjb25zdCBzbGlkZXJBcnJvd0ljb24gPSBzbGlkZXJQcmV2QXJyb3cuZmluZChgaW1nYCk7XG4gICAgICBzbGlkZXJBcnJvd0ljb24uYXR0cihgc3JjYCwgYGltZy9pY29ucy9hcnRpY2xlLXNsaWRlci1wcmV2YXJyb3ctLWluYWN0aXZlLnN2Z2ApO1xuICAgIH1cbiAgICBpZiAoIXNsaWRlckxhc3ROYXYuaGFzQ2xhc3MoYHRucy1uYXYtYWN0aXZlYCkpIHtcbiAgICAgIGNvbnN0IHNsaWRlckFycm93SWNvbiA9IHNsaWRlck5leHRBcnJvdy5maW5kKGBpbWdgKTtcbiAgICAgIHNsaWRlckFycm93SWNvbi5hdHRyKGBzcmNgLCBgaW1nL2ljb25zL2FydGljbGUtc2xpZGVyLW5leHRhcnJvdy5zdmdgKTtcbiAgICB9XG4gIH0pO1xuXG4gIHNsaWRlck5leHRBcnJvdy5vbihgY2xpY2tgLCAoKSA9PiB7XG4gICAgaWYgKHNsaWRlckxhc3ROYXYuaGFzQ2xhc3MoYHRucy1uYXYtYWN0aXZlYCkpIHtcbiAgICAgIGNvbnN0IHNsaWRlckFycm93SWNvbiA9IHNsaWRlck5leHRBcnJvdy5maW5kKGBpbWdgKTtcbiAgICAgIHNsaWRlckFycm93SWNvbi5hdHRyKGBzcmNgLCBgaW1nL2ljb25zL2FydGljbGUtc2xpZGVyLW5leHRhcnJvdy0taW5hY3RpdmUuc3ZnYCk7XG4gICAgfVxuICB9KTtcblxufSk7XG5cbi8qIEluaXRpYXRlIHNsaWRlcnMgKi9cbmNvbnN0IGFydGljbGVDYXJvdXNlbCA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoYCNhcnRpY2xlQ2Fyb3VzZWxgKTtcbmlmIChhcnRpY2xlQ2Fyb3VzZWwpIHtcbiAgY29uc3Qgc2xpZGVyID0gdG5zKHtcbiAgICBjb250YWluZXI6IGAjYXJ0aWNsZUNhcm91c2VsYCxcbiAgICBzbGlkZUJ5OiBgcGFnZWAsXG4gICAgaXRlbXM6IDEsXG4gICAgY29udHJvbHNDb250YWluZXI6IGAjYXJ0aWNsZVNsaWRlckNvbnRyb2xzYCxcbiAgICBuYXZDb250YWluZXI6IGAjYXJ0aWNsZVNsaWRlck5hdmAsXG4gICAgbG9vcDogZmFsc2UsXG4gIH0pO1xufVxuXG5jb25zdCBkZXNrdG9wUHJvbW9TbGlkZXIgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKGAjZGVza3RvcFByb21vU2xpZGVyYCk7XG5pZiAoZGVza3RvcFByb21vU2xpZGVyKSB7XG4gIGNvbnN0IGRlc2t0b3BQcm9tb1NsaWRlciA9IHRucyh7XG4gICAgY29udGFpbmVyOiBgI2Rlc2t0b3BQcm9tb1NsaWRlcmAsXG4gICAgc2xpZGVCeTogYHBhZ2VgLFxuICAgIGl0ZW1zOiAxLFxuICAgIGNvbnRyb2xzOiBmYWxzZSxcbiAgICBuYXY6IGZhbHNlLFxuICB9KTtcbn1cblxuY29uc3QgbW9iaWxlUHJvbW9TbGlkZXIgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKGAjbW9iaWxlUHJvbW9TbGlkZXJgKTtcbmlmIChtb2JpbGVQcm9tb1NsaWRlcikge1xuICBjb25zdCBtb2JpbGVQcm9tb1NsaWRlciA9IHRucyh7XG4gICAgY29udGFpbmVyOiBgI21vYmlsZVByb21vU2xpZGVyYCxcbiAgICBzbGlkZUJ5OiBgcGFnZWAsXG4gICAgaXRlbXM6IDEsXG4gICAgY29udHJvbHM6IGZhbHNlLFxuICAgIG5hdjogZmFsc2UsXG4gIH0pO1xufVxuXG5jb25zdCBtYWluUHJvbW9TbGlkZXIgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKGAjbWFpblByb21vQ2Fyb3VzZWxgKTtcbmlmIChtYWluUHJvbW9TbGlkZXIpIHtcbiAgY29uc3QgbWFpblByb21vU2xpZGVyID0gdG5zKHtcbiAgICBjb250YWluZXI6IGAjbWFpblByb21vQ2Fyb3VzZWxgLFxuICAgIHNsaWRlQnk6IGBwYWdlYCxcbiAgICBpdGVtczogMSxcbiAgICBjb250cm9sczogZmFsc2UsXG4gICAgbmF2OiBmYWxzZSxcbiAgfSk7XG59XG5cbi8qIEdlbmVyYXRlIHJhbmRvbSBJRCAqL1xuXG5jb25zdCBnZW5lcmF0ZVJhbmRvbUlkID0gKGxlbmd0aCkgPT4ge1xuICBjb25zdCBsZXR0ZXJzID0gYDAxMjM0NTY3ODlBQkNERUZHSElKS0xNTk9QUVJTVFVWV1hUWmFiY2RlZmdoaWtsbW5vcHFyc3R1dnd4eXpgLnNwbGl0KGBgKTtcblxuICBpZiAoIWxlbmd0aCkge1xuICAgIGxlbmd0aCA9IE1hdGguZmxvb3IoTWF0aC5yYW5kb20oKSAqIGxldHRlcnMubGVuZ3RoKTtcbiAgfVxuXG4gIGxldCBzdHIgPSBgYDtcblxuICBmb3IgKGxldCBpID0gMDsgaSA8IGxlbmd0aDsgaSsrKSB7XG4gICAgc3RyICs9IGxldHRlcnNbTWF0aC5mbG9vcihNYXRoLnJhbmRvbSgpICogbGV0dGVycy5sZW5ndGgpXTtcbiAgfVxuICByZXR1cm4gc3RyO1xufTtcblxuLyogUG9zdCBib29rbWFyayBjbGljayAqL1xuY29uc3QgYXJ0aWNsZSA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoYC5hcnRpY2xlYCk7XG5jb25zdCBwb3N0Qm9va21hcmsgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKGAucG9zdC1ib29rbWFya2ApO1xuY29uc3QgcG9zdEJvb2ttYXJrTW9iID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcihgLnBvc3QtYm9va21hcmstLW1vYmApO1xuXG5pZiAoYXJ0aWNsZSkge1xuICBhcnRpY2xlLnNldEF0dHJpYnV0ZShgZGF0YS1pZGAsIGdlbmVyYXRlUmFuZG9tSWQoOCkpO1xufVxuXG5pZiAocG9zdEJvb2ttYXJrKSB7XG4gIHBvc3RCb29rbWFyay5hZGRFdmVudExpc3RlbmVyKGBjbGlja2AsIChldnQpPT57XG4gICAgZXZ0LnByZXZlbnREZWZhdWx0KCk7XG5cbiAgICBsZXQgYXJ0aWNsZUlkID0gYXJ0aWNsZS5nZXRBdHRyaWJ1dGUoYGRhdGEtaWRgKTtcbiAgICBsZXQgYXJ0aWNsZUNvb2tpZU5hbWUgPSBgZGF0YS1pZGA7XG4gICAgbGV0IHBvc3RCb29rbWFya0ljb24gPSBwb3N0Qm9va21hcmsucXVlcnlTZWxlY3RvcihgaW1nYCk7XG5cbiAgICBpZiAocG9zdEJvb2ttYXJrSWNvbi5nZXRBdHRyaWJ1dGUoYHNyY2ApID09PSBgaW1nL2ljb25zL2ljb24tYm9va21hcmsuc3ZnYCkge1xuICAgICAgcG9zdEJvb2ttYXJrSWNvbi5zZXRBdHRyaWJ1dGUoYHNyY2AsIGBpbWcvaWNvbnMvaWNvbi1ib29rbWFyay1maWxsLnN2Z2ApO1xuICAgIH0gZWxzZSB7XG4gICAgICBwb3N0Qm9va21hcmtJY29uLnNldEF0dHJpYnV0ZShgc3JjYCwgYGltZy9pY29ucy9pY29uLWJvb2ttYXJrLnN2Z2ApO1xuICAgIH1cblxuICAgIGxldCBjb29raWVEYXRlID0gbmV3IERhdGUoKTtcbiAgICBjb29raWVEYXRlLnNldFRpbWUoY29va2llRGF0ZS5nZXRUaW1lKCkgKyAoMTQ0MCAqIDYwICogMTAwMCkpO1xuICAgIGxldCBkYXRlID0gY29va2llRGF0ZS50b1VUQ1N0cmluZygpO1xuXG4gICAgZG9jdW1lbnQuY29va2llID0gZW5jb2RlVVJJQ29tcG9uZW50KGFydGljbGVDb29raWVOYW1lKSArIGA9YCArIGVuY29kZVVSSUNvbXBvbmVudChhcnRpY2xlSWQpICsgYGV4cGlyZXM9YCArIGRhdGU7XG4gIH0pO1xufVxuXG5pZiAocG9zdEJvb2ttYXJrTW9iKSB7XG4gIHBvc3RCb29rbWFya01vYi5hZGRFdmVudExpc3RlbmVyKGBjbGlja2AsIChldnQpPT57XG4gICAgZXZ0LnByZXZlbnREZWZhdWx0KCk7XG5cbiAgICBsZXQgYXJ0aWNsZUlkID0gYXJ0aWNsZS5nZXRBdHRyaWJ1dGUoYGRhdGEtaWRgKTtcbiAgICBsZXQgYXJ0aWNsZUNvb2tpZU5hbWUgPSBgZGF0YS1pZGA7XG4gICAgbGV0IHBvc3RCb29rbWFya0ljb24gPSBwb3N0Qm9va21hcmtNb2IucXVlcnlTZWxlY3RvcihgaW1nYCk7XG5cbiAgICBpZiAocG9zdEJvb2ttYXJrSWNvbi5nZXRBdHRyaWJ1dGUoYHNyY2ApID09PSBgaW1nL2ljb25zL2ljb24tYm9va21hcmsuc3ZnYCkge1xuICAgICAgcG9zdEJvb2ttYXJrSWNvbi5zZXRBdHRyaWJ1dGUoYHNyY2AsIGBpbWcvaWNvbnMvaWNvbi1ib29rbWFyay1maWxsLnN2Z2ApO1xuICAgIH0gZWxzZSB7XG4gICAgICBwb3N0Qm9va21hcmtJY29uLnNldEF0dHJpYnV0ZShgc3JjYCwgYGltZy9pY29ucy9pY29uLWJvb2ttYXJrLnN2Z2ApO1xuICAgIH1cblxuICAgIGxldCBjb29raWVEYXRlID0gbmV3IERhdGUoKTtcbiAgICBjb29raWVEYXRlLnNldFRpbWUoY29va2llRGF0ZS5nZXRUaW1lKCkgKyAoMTQ0MCAqIDYwICogMTAwMCkpO1xuICAgIGxldCBkYXRlID0gY29va2llRGF0ZS50b1VUQ1N0cmluZygpO1xuXG4gICAgZG9jdW1lbnQuY29va2llID0gZW5jb2RlVVJJQ29tcG9uZW50KGFydGljbGVDb29raWVOYW1lKSArIGA9YCArIGVuY29kZVVSSUNvbXBvbmVudChhcnRpY2xlSWQpICsgYGV4cGlyZXM9YCArIGRhdGU7XG4gIH0pO1xufVxuIl0sImZpbGUiOiJtYWluLmpzIn0=
